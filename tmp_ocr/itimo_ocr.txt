
===== page-01.png =====

@ iTIMO: An LLM-empowered Synthesis Dataset for Travel
Itinerary Modification

Zhuoxuan Huang
Jilhzx@esu.edu.cn
Central South University
Changsha, Hunan, China

Hua Ma
huama@hunnu.edu.cn
Hunan Normal University
Changsha, Hunan, China

Abstract

Addressing itinerary modification is crucial for enhancing the travel
experience as it is a frequent requirement during traveling. How-
ever, existing research mainly focuses on fixed itinerary planning,
leaving modification underexplored. To bridge this gap, we for-
mally define the itinerary modification task and introduce iTIMO,
a dataset specifically tailored for this purpose. We identify the lack
of need-to-modify itinerary data as the critical bottleneck hindering
research on this task and propose a general pipeline to overcome it.
This pipeline frames the generation of such data as an intent-driven
perturbation task, It instructs large language models to perturb real
world itineraries using three atomic editing operations: REPLACE,
ADD, and DELETE. Each perturbation is grounded in three intents,
including disruptions of popularity, spatial distance, and category
diversity, Furthermore, a hybrid evaluation metric is designed to en-
sure perturbation effectiveness. We conduct comprehensive experi-
ments on iTIMO, revealing the limitations of current LLMs and lead
to several valuable directions for future research. Dataset and cor-
responding code are available at https://github.com/zelo2/iTIMO.

CCS Concepts

«Information systems — Information retrieval; Evaluation
of retrieval results; Recommender systems.

Keywords

Travel Recommendation Systems, Large Language Model, Itinerary
Modification, Synthetic Data Generation

“Corresponding Authors.

Permission to make digital or hard copies of all or part of this work for personal or
classroom use is granted without fee provided that copies are not made or distributed
for profit or commercial advantage and that copies bear this notice and the full citation
on the First page. Copyrights for components of this work owned by others than the
author(s} must be honored. Abstracting with credit is permitted. To copy otherwise, or
republish, to post on servers or to redistribute to lists, requires prior specific permission
and/or a fee. Request permissions from permissions@acm org

Conference acronym "XX, Woodstock, NY

© 2018 Copyright held by the owner/author(s). Publication rights licensed to ACM.
ACM ISBN 978-1-4503-XXXX-X/2018/06

Inttps://doi. org/ 70000 JOO

Yunshan Ma
ysma@smu.edu.sg
Singapore Management University
Singapore, Singapore

Hongyu Zhang”
hyzhang@csu.edu.cn
Central South University
Changsha, Hunan, China

Zhu Sun*
zhu_sun@sutd.edu.sg
Singapore University of Technology
and Design
Singapore, Singapore

ACM Reference Format:

Zhuoxuan Huang, Yunshan Ma, Hongyu Zhang, Hua Ma, and Zhu Sun.
2018. @ iTIMO: An LLM-empowered Synthesis Dataset for Travel Itinerary
Modification . In Proceedings of (Conference acronym ‘XX).. ACM, New York,
NY, USA, 35 pages. https://doi.org/XXXXKXX.XXXKXXK

1 Introduction

‘Travel Recommendation Systems (TRSs) are instrumental in the
tourism domain, designed to facilitate personalized itinerary plan-
ning in response to user inquiries [11]. Typically, given auser query
specifying a departure point, destination, and various constraints
(eg, time and budget), a TRS seeks to construct a valid itinerary
satisfying these constraints. Due to the practical and economic
value in the tourism domain, TRSs have garnered extensive atten-
tion from both academia and industry [7-9]. Research on TRSs has
continuously evolved, transitioning from early optimization-based
approaches [18, 50, 51] to deep learning models [8-10]. Recently, the
advent of large language models (LLMs) has prompted researchers
to investigate their potential in advancing TRSs [7, 46].

While itinerary planning is fundamental to the tourism domain,
itinerary modification represents an equally critical need in real-
world scenarios. As illustrated in Figure 1, modification requests
frequently occur across different phases, including both before and
during traveling, Users often need to modify their itineraries by
adding a new point-of- interest (POI) or replacing a undesired one
due to subjective preferences or objective conditions. Consequently,
the ability to address such modification requests is indispensable for
ensuring a satisfactory travel experience. Despite this critical need,
current TRSs mainly focus on fixed itinerary planning, leaving
modification underexplored. The primary reason for this gap is that
public travel datasets [2, 46] contain real-world itineraries but lack
the need-to-modify itineraries essential for this task.

Generating need-to-modify itineraries is a non-trivial task. As
shown in Figure 1, user inquiries stem from various intents (e.g.,
seeking popular POls in close proximity or pursuing category diver-
sity for exploration) and operations (e.g, add or replace). This vari-
ability increases the complexity of constructing a comprehensive
dataset for itinerary modification. Meanwhile, large-scale manual
annotation is expensive and labor-intensive. Furthermore, relying


===== page-02.png =====

Conference acronym "XX, June 03-05, 2018, Woodstock, NY

Phase 1 (@efare Traveling) Phase 2 (During Traveling)

Tra traveling to Melbourne,
please help me arrange an
itinerary with high popularity
and

frm traveling to Melbourne, and
here is my pre-planned itinerary:

Park | ThaoivoLhe Theatre Lie
Law Pop.” "High Pop" "High Pop
I'm heading to the second PO!

while i is too crowded to vist

(Objective! tector). Please help

Ta to REPLACE it to make the

itinerary mora explorative (Subj-

ective preference)

Here is a one-day tinerary
with popular POls, and each
adjacent pair is

2k

ThestreLie Ville Emtre
ingest einer Ct

er)

Tels short for me, ean you ADD @
new POI to modify this itinerary?

CUEeRERRO ee Ca eee

Figure 1: Illustrations of itinerary modification scenarios across two
phases: before and during traveling. Users may proactively request
to ADD POI based on subjective preferences (Phase 1), or REPLACE
POI due to objective conditions such as overcrowding (Phase 2).

on human validation risks introducing subjective bias that compro-
mises reliability. In light of these obstacles, we aim to investigate:
Can we automatically generate need-to-modify itineraries to construct
a diverse, scalable, and high-quality itinerary modification dataset?

To achieve this goal, we formulate data construction as an intent-
driven perturbation task grounded in real-world itineraries that
implicitly encode user intents (e.g., preferences regarding popular-
ity). By strategically perturbing itineraries, we induce a divergence
from the user's original intentions, thereby creating valid scenarios
that necessitate modification and enabling the synthesis of realistic
need-to-modify itineraries. However, this process requires manag-
ing complex dependencies within itineraries, such as maintaining
spatial coherence or adhering to popularity preferences. To address
this problem, we seek to leverage LLM, which is a promising ap-
proach given that its rich real-world knowledge enables perceiving
various relationships [19, 46].

Implementing this idea, we propose iTIMO, an LLM-empowered
synthetic dataset which comprises three sub-datasets for iTInerary
MOdification. First, we frame the generation of need-to-modify
itineraries as an intent-driven perturbation task, incorporating
three operations (replace, add, delete) and three intents (disrupting
popularity, spatial distance, or category diversity). These concepts
ensure the task diversity of our constructed datasets. We explicitly
select these three intents as they represent the fundamental factors
of user travel preferences established in prior research [9]. Disrupt-
ing itineraries based on these intents effectively simulates realistic
scenarios where the itinerary fails to meet user expectations. Sec-
ond, we propose hybrid evaluation metrics to assess the divergences
between real-world itineraries and their perturbed versions from
both macro and micro perspectives, providing measurable signals
to facilitate high-quality perturbations. Third, we propose a general
pipeline to construct {TIMO based on three public travel datasets. It
can be seamlessly applied to any travel dataset, exhibiting its scala-
bility. Moreover, in the proposed pipeline, we incorporate function
calling and a memory module into an LLM to address the limita-
tions of existing LLMs in itinerary perturbation (cf, Section 5.2),
further ensuring the diversity and quality of constructed datasets.

Huang et al.

Besides the datasets, we conduct comprehensive benchmarking
on iTIMO to systematically investigate the itinerary modification
task. Specifically, we select various advanced baselines including
eight base LLMs with varying scales and families, and two large
reasoning models (LRMs) to explore the boundaries of founda-
tional model capabilities in handling sucha novel task. Additionally,
we explore the effects of advanced methodologies, ie, retrieval-
augmented generation (RAG) [25] and post-training strategies such
as supervised fine-tuning (SFT) [22], to provide a holistic view
of effective paradigms for addressing the itinerary modification
challenge. Our experiments yield several interesting insights. For
example, small-scale models (e.g., 8B) with SFT can surprisingly
outperform LRMs, and naively combining RAG with SFT does not
always guarantee incremental improvements. Those findings shed
light on promising future directions.

Insummary, our contributions include: (1) A dataset for anovel
task: To the best of our knowledge, we are the first to propose the
itinerary modification task and its corresponding iTIMO dataset to
facilitate future research. (2) A general pipeline for data gen-
eration: We propose a general LLM-based pipeline to generate
itinerary modification dataset based on real-world public datasets.
(3) Comprehensive benchmarking: Extensive experiments on
iTIMO datasets have unveiled meaningful insights and lead to sev-
eral noteworthy and valuable directions for future research.

2 Related Work

Itinerary Planning Benchmarks. Early studies extracted real-
world itineraries from geo-tagged Flickr photos [41], creating datasets
for cities like Melbourne [43] and Florence [30]. Recently, Trav-
ePlanner [46] introduced a sandbox environment to evaluate LLM
agents under multi-level constraints. After that, numerous efforts
have been devoted to improve it in terms of dataset quality (e.g,
ChinaTravel [36], ITINERA [39], TripScore [35], TripTailor [42],
RealTravel [37], RETAIL [13], and TP-RAG [31]) and evaluation
metric (eg., TripScore [35], Travel-Sim [48], and TripCraft [6]}.
Moreover, there are several studies focusing on generating person-
alized queries for travel destination recommendations [2, 45]. While
these benchmarks advance static itinerary planning, the dynamic
scenario of itinerary modification remains underexplored, limiting
the efficacy of TRSs in handling real-time user needs.

Itinerary Planning Methods. Itinerary planning has evolved from
optimization-based approaches using classic algorithms [18, 50]
or linear solvers [51] to deep learning models involving reinforce-
ment leaming [10] and graph neural networks (8, 9]. Following the
success of LLMs, recent works improve planning via satisfiability
modulo theory [21], hierarchical decomposition [19, 55], and hy-
brid solvers for personalization [37]. Despite these advancements,
existing research predominantly targets generating fixed itineraries.
This leaves a critical gap in modifying existing itineraries to accom-
modate subjective preferences or objective constraints.

3 Problem Definition

Given a set of real-world itineraries £ composed of POIs from
the POI set P, an itinerary i € F is a chronological sequence of
POIs, where each POI is characterized by a tuple (c, lat, long, pop)
denoting its category, geographic coordinates, and popularity. To

===== page-03.png =====

iTIMO: An LLM-empowered Synthesis Dataset for Travel Itinerary Modification

systematically model modification scenarios, we generalize typ-
ical user requests (cf Figure 1) into a set of atomic operations
O = {adds Oreplace: Odetere }» Corresponding to adding a POI from
the candidate set 6; = P \ i, replacing a POI with one from %j,
and deleting a POI within i. Furthermore, grounded in established
travel preferences (ie. popularity, spatial distance, and diversity)
[9]. we define the perturbation intent set Z = {zpop,2ais:Zdiv}-
These intents guide the generation of need-to-modify instances by
intentionally disrupting specific itinerary attributes. Formally, we
define the two core tasks as follows:

Definition 1 (Itinerary Perturbation Task). For each real-
world itinerary i ¢ 2, the perturbation task aims to generate a
need-to-modify itinerary i* by applying an operation o € O. The
resulting i* is constrained to exhibit attribute disruptions aligned
with the given intents z C Z.

Definition 2 (Itinerary Modification Task). Given a need-to-
modify itinerary i*, the itinerary modification task aims to revert it
to the original itinerary i through an operation 0 € O.

4 Evaluation of Itinerary Perturbation

Itinerary perturbation quality is crucial for dataset construction.
Since current methods lack mechanisms to verify if perturbations
align with specific intents, we propose a hybrid evaluation metric
to quantify intent fulfillment and ensure data reliability.

4.1 Identifying Category Diversity Disruption
For the intent zyjy. given an itinerary i, we define there exists a
disruption of category diversity once dio(i) # div(i*), where i* is
the perturbed itinerary based on i, div(.) is the function to compute
category diversity:

div(i) = 0 if €unique(c!) =

funique(c!)/lilotherwise. (1)

InEgq. (1), #unigue (c'} denotes the number of unique POI categories
in the itinerary i, c! is the categories within i, and |i] represents the
number of POIs in i.

4.2 Identifying Popularity Disruption

For the intent zpop, we define the popularity disruption from the
macro and micro views. From the macro view, popularity disrup-
tion refers to the popularity distribution shift between an itinerary
and its perturbed version. To get the itinerary’s popularity distri-
bution, we categorize the popularity level of each POI within the
itinerary into [low, medium, high} based on the visit frequency:

DP? (i) = {Apopl [lil #pop?" ld, #popl/il} @)

where DP¢? (i) denotes the popularity distribution of itinerary i,
#popl, tpop™, and #pop denote the number of POIs with low,
medium, and high popularity level within i, respectively.

Based on it, common evaluation metrics such as Jensen Shan-
non divergence (JSD) [27], total variation distance (TVD) [24], or
Hellinger distance (H) [23] can be used to identify the macro distri-
bution shifts for disruption identification. In this paper, we choose
Hellinger distance as the evaluation metric, defined as follows:

Conference acronym "XX, June 03-05, 2018, Woodstack, NY

H(DPer (ay, DP) =a" |S" (Yeporti yepope ll |
retin)

re)
Hellinger distance is selected for its superior sensitivity to extreme
distribution shift cases. For instance, an itinerary i contains 5 high-
popularity, 5 medium-popularity, and 1 low-popularity POIs. When.
the low-popularity POI is deleted to generate i*, the perturbation re-
flects a preference shift from tolerating to excluding low-popularity
POIs. The resulting distributions are DP¢? (i) = [5/11,5/11,1/11]
and DP¢P(i*) = [1/2,1/2,0]. Quantitatively, the Hellinger dis-
tance (H = 0.216) yields a stronger signal than JSD (0.0474) or TVD
(0.0909), thereby effectively capturing disruptions in our task.

From the micro view, popularity disruption refers to the popular-
ity ranking order shift. Given the itinerary i with 5 high-popularity
POls, 1 medium-popularity POI and 5 low-popularity POIs, the
perturbed itinerary i* is generated by deleting a low-popularity
one. This perturbation reflects a preference shift moving from a
preference for a mix of high and low-popularity POIs to a stronger
preference for high-popularity POIs, which also satisfies 2?¢?, Al-
though this preference change is semantically significant, its impact
on the overall distribution is minimal, resulting in a low value of
H (0.039). This underscores the insensitivity of distribution-based
metrics to such nuanced micro-level preference shift, highlighting
the need for complementary evaluation methods.

To address it, we introduce Kendall's r, to capture such a micro
ranking order shift, similar to [17], which is computed as follows:

Tp = (Me — na) f-¥ (na — 21)(M9 = 72), (a)

where ne and ng denote the number of concordant and discordant
pairs, respectively, no is the total number of pairs, 1 and nz repre-
sent the total number of pairs tied in the itinerary i and its perturbed
version i*, respectively.

In summary, we can incorporate the H value and 1, to identify
popularity disruption. Given an itinerary i, the perturbation results
i* satisfies 2P°? if H(DP°?P (7), DPCP (i*)) > 6 or t < 1, where # is
the threshold. In this paper, we set 6 = 0.1, and we theoretically
prove the effectiveness of this value in the Appendix.

4.3 Identifying Spatial Distance Disruption

Analogously, we identify the disruption of spatial distance through
the incorporation of H value and r,. The spatial distance distribu-
tion of a given itinerary i is obtained by:

D#* (iy = [tais}[lil, Adis?" /lil, adish /lil}, (5)

where #dis!, #dis”, and #dis!' denote the number of POIs with low,
medium, and high distance level within i, respectively.

To establish distance levels, we compute the distance between
all successive POIs across all itineraries in the dataset via the Haver-
sine formula [38]. Based on the statistical distribution of these
collected distances, we categorize them into three distance levels:
low, medium, and high.

===== page-04.png =====

Conference acronym "XX, June 03-05, 2018, Woodstock, NY

Instruction (System Prompt) | Input Data (User Prompt)

extract

7 ee
ADO/REPLACE/DELETE Dataset

Pashworld Itherary CondMlate POIs

Foal alieg contract

poy

Perturbation
Irtent Set

Ux

2) Memary

@e P geo_distance_segments (}
perturbation are {} Write

Necd-to-madtfy| iTIMO
Thararee | OOD)

Dataset

Figure 2: Overall pipeline of iTIMO dataset construction. The top
part introduces the process of prompt construction (cf: Section 5.1).
In the middle part, we propose V3.2 FM for high-quality itinerary
perturbation (cf: Section 5.2). In the bottom part, we manually filter
noise to construct iTIMO dataset (¢f: Section 5.3).

Table 1: Comparison between DeepSeek models and our V3.2 FM on
different perturbation operations.

Operation] Model POLDiv. Pet Ace. Avg time Avg tokens Avg cost (6)
va ons 70 2738 3025.7 o.0028
ADD R32 Ost 094 BBA3s 1008.9 9.0289
V3.2EM (Ours) 0.84 400 1024s toar0.1 o.0042
va 0.68 082 2355 2028.9 0.0019
DELETE R32 0.86 098 4745s 4715 0186
V3.20M (Ours) 0.70 400 98.85 12508 6 2.0048,
va 019 068 2578 3738.7 0.0008
REPLACE R32 a7 098 5900s (8008.8 2.0289
V3.2EM (Ours) 0.74 400 1003s 1326.3 2.0089

dh dad

{b) V32/ DELETE,

(2) V2.7 ADD (0) W342) REPLACE

V3.2 EM? ADD

Figure 3: Visualization of perturbation positions for V3.2 and our
‘V3.2 FM, where each column corresponds to one itinerary, Mil indi-
cates an existing POI, and [| indicates a perturbation position.

5 Pipeline for iTIMO Dataset Construction

This section details the integration of our proposed metrics to gen-
erate high-quality itinerary perturbations for {TIMO construction.
The overall pipeline is illustrated in Figure 2.

Huang et al.

5.1 Prompt Template Design

For each operation 0 € O, we design a prompt template mo. The
system prompt establishes foundational task context, incorporat-
ing our hybrid evaluation metrics to provide semantic grounding
for high-quality perturbations. The user prompt then provides the
contextualized input, including the original itinerary i ¢ Z, can-
didate POIs &;, and target perturbation intents z C Z. To ensure
diverse perturbation intents, we constrain the number of intents |z|

by uniformly sampling from {1, 2, 3}. Formally, the prompt-based
perturbation process for each operation o is formulated as:

P= fol nz | te), (6)

where fa(-) denotes the LLM whose parameters are denoted by ©.

5.2. Itinerary Perturbation Method

‘We conduct a preliminary study to investigate the effectiveness of
LLMs in itinerary perturbation task. Our experimental datasets are
constructed by sampling 50 itineraries from each of the three public
travel datasets: Toronto [26], Melbourne [43], and Florence [30].
We utilize DeepSeck models [28] as baselines under two settings:
a thinking mode (R3.2) and a non-thinking mode (V3.2), with in-
context leaming (ICL) [3] applied to provide explicit guidance. We
only show the results in the Melboume dataset due to similar results
in other datasets and limited space, illustrated as Table 1. Here,
POI Div, quantifies the variety of POIs selected for perturbations,
while Pert. Acc. measures perturbation accuracy by assessing the
alignment between results and intents. It can be found that that R3.2
outperforms V3.2 in both diversity and accuracy, demonstrating
the priority of reasoning in itinerary perturbation task.

However, the long reasoning context of R3.2 leads to inefficien-
cies and high token consumption, making the model computa-
tionally and financially expensive to deploy. To better balance the
trade-off between performance and efficiency, we build upon V3.2
to propose V3.2 with function calling (FC) and memory module,
termed as V3.2 FM. They are introduced to address the accuracy
and diversity issues, respectively.

Regarding the accuracy issue, analysis of V3.2 and R3.2 failure
cases attributes it to computational limitations. For example, scruti-
nizing the R3.2’s chain-of-thought reveals the model's reliance on
an estimation strategy for spatial distance computation, explicitly
stating "Since Tam a language model, I will approximate it." This
approximation may misclassify short spatial distances, erroneously
categorizing low-level distances into the medium-level category. To
remedy this, we integrate FC to replace error-prone textual estima-
tion with precise computation, As illustrated in Figure 2, we build
a tool box to enable the model to access exact numerical values via
FC, effectively eliminating computational hallucinations caused by
approximation, Experimental results reported in Table 1 demon-
strate that our V3.2 FM achieves optimal perturbation accuracy
across all operations, while simultaneously reducing inference time
and token consumption compared to the R3.2 reasoning model.

Regarding the diversity issue, beyond the limited POL diversity
reported in Table 1, visualizations in Figure 3 (a)-(c) also confirm
V3.2 suffers from a severe positional bias, failing to explore the
full range of modification points. To address this deficiency, we
introduce a memory module, inspired by [4]. As shown in Figure 2,
this module records the history of selected POIs and perturbation

===== page-05.png =====

iTIMO: An LLM-empowered Synthesis Dataset for Travel Itinerary Modification

Table 2: Statistics information of iTIMO dataset, where |z| denotes
the number of intents behind one perturbed itinerary.

| iTIMO-Toronto |iTIMO-Melbourne | iTIMO-Florence

Metric

| DEL. ADD REP. | DEL. ADD REP | DEL. ADD REP.
# POs 43 64 73) 188 211 168] 863 862 863
# Itineraries| 334 321 333] 401 375 398 | 4439 4281 4382
Avg length | 471 274 3.71| Sel 369 457[1027 825 9.14
* ([2I 2 10S 44) 35 105 91] 845 1555 1255
# (l2I 110 150, 182) 192 an 195} 2182 2002 2255
* (lal 201 66 107| 174 8 «1121412722 871
# aia 253 166 156] 253 171 155] 3229 2880 1909
# dis 317 185 289] 352 293 326| 3429 2414 3202
# Zpop 27¢ 252 284] 336 250 336 | 2787 2431 3267

positions. By injecting this log into the input prompt, we effectively
discourage the LLM from repeating previous modification actions.
Experimental results shown in both Table 2 and Figure 3 (d)-(6)
verify the effectiveness of the proposed memory module,

Notably, our perturbation method exhibits high generality as it
can be seamlessly applied to any datasets containing geographic,
popularity, or categorical POI information, which are common
features for public travel datasets. This allows for easy expansion
of iTIMO to other global cities.

5.3. iTIMO Dataset

‘The iTIMO dataset, comprising of three sub-datasets, is constructed
by utilizing V3.2 FM to perturb real-world itineraries derived from
three public travel datasets: Toronto [26], Melbourne [43], and
Florence [30]. This selection ensures coverage across diverse geo-
graphical and cultural contexts, After that, we manually filter errors
and noise to guarantee the data quality. The statistical information
of iTIMO are summarized in Table 2.

6 Experiment

In this section, we conduct experiments to answer the following
research questions (RQs). (1) RQ1: How do existing advanced LLMs
perform in the itinerary modification task? (2) RQ2: How do dif-
ferent retrieval-augmented generation (RAG) methods influence
LLMs’ performance? (3) RQ3: How do SFT paradigms affect LLMs”
performance? (4) RQ4: Can SFT and RAG be combined to yield
consistent incremental improvements?

6.1 Experimental Setup

Datasets and baselines. We utilize the {TIMO for our experi-
ments, evaluating each operation across all sub-datasets to provide
a fine-grained analysis. Each dataset is split into training, valida-
tion, and test sets in a 7:1:2 ratio. We choose eight base LLMs (ie,
Gemma-4b [40], Llama-3.1-8b [14], Qwen3-8/32b [47], Phid-15b [1],
Mistral-24b [29], DeepSeek V3.2 [12], and GPT-4.1 [32]), two LRMs
(ie, DeepSeek R3.2 [20] and GPT-o4 mini [34]) as the baseline ap-
proaches. Additionally, to assess the impact of domain adaptation,
we apply supervised fine-tuning (SFT) to three selected LLMs via
Low-Rank Adaptation (LoRA) [22].

Evaluation Protocols. We utilize Modification Accuracy (Mod)
and All Pass Rate (APR) for evaluations. Mod serves asa strict metric
to verify alignment between modification results and ground-truth,
whereas APR acts as a soft metric to assess whether the outputs
satisfy the provided hints. For instance, given an need-to-modify

Conference acronym "XX, June 03-05, 2018, Woodstack, NY

itinerary and its hint requiring to modify the popularity distribu-
tion, APR equals to 1 if the modification result only changes the
popularity distribution and remains the other two distributions in-
variant. The evaluation metrics in Section 4 are used for evaluating
whether distribution shifts here.

Experimental Settings. We design prompts including task def-
initions and structured inputs for experiments. Specifically, the
input comprises the need-to-modify itinerary, candidate POls with
4 negative samples and 1 ground-truth, and a high-level hint spec-
ifying the modification aspect (eg., diversity, popularity or dis-
tance). Moreover, to investigate the effects of in-context learning
(ICL), we explore three RAG strategies [5, 53] for example selec-
tion: random, sparse, and dense, The random (few-shot) strategy
randomly samples K training examples, and the sparse strategy
(RAG-Hint) retrieves the top-K by hint similarity. The dense strat-
egy embeds the input itinerary and hint together with candidate
samples into a shared vector space and selects top-K by cosine
similarity. We set K = 3 and use three retrievers including KaLM-
Gemma3-12b-emd [54], Qwen3-8b-emd [52], and GPT-text-emd-3-
large [33] due to their strong performance on MMTEB benchmark
[16]. The DeepSeek and GPT series models are accessed via APIs,
and other LLMs are deployed on a A800 GPU for experiments.

6.2. Main Results Analysis (RQ1)

Table 3 presents the experimental results yielding the following
findings. (1) Current LLMs demonstrate high performance on the
single-stage DELETE operation but struggle with multi-stage op-
erations which necessitate both position and POI selections. This
limitation is exacerbated in the ADD operation, which is more
challenging than REPLACE due to the increasing search space. (2)
Stronger backbone capacity leads to better performance. Within
the Qwen3 family, Qwen3-32b outperforms Qwen3-8b in most
cases. This confirms that scaling parameter size effectively enhances
model capabilities in handling itinerary modifications. (3) Perfor-
mance varies significantly across model families even with identical
parameter counts. Despite both being 8B models, Qwen3-ab gener-
ally surpasses Llama-3.1-8b across various settings. (4) While RAG
improves base LLMs, SFT is the key to making small models per-
form as well as LRMs. SFT is particularly notable because it enables
8B models to compete with much larger models. In summary, we
answer RQl: existing advanced LLMs face significant challenges in
complex, multi-stage modifications, though increasing model scale
and selecting stronger backbone architectures can partially mitigate
these limitations.

6.3 In-depth Analysis (RQ2-RQ4)

Effects of retriever (RQ2). Here, we aim to figure out the effects of
different retrievers. Similar to [49], we adopt a Borda count [15] to
aggregate our experimental results for better overall comparisons.
Specifically, we rank 5 RAG settings’ performance for each base
LLM, each modification operation, and each dataset. The best setting
receives 4 points, the worst setting receives 0 points, and ties are
handled by assigning the averaged points of the tied ranks. We
compute the Borda count separately for Mod and APR (8 base LLMs
x3 datasets x3 operations = 72 cases per metric). Table 4 reports the
experimental results. Overall, we can answer RQ2: RAG significantly

===== page-06.png =====

Conference acronym ’XX, June 03-05, 2018, Woodstock, NY Huang et al,
Table 3: Itinerary modification performance across datasets, operations, LLMs, and RAG settings, where denotes base LLMs, denotes
LRMs, denotes LLMs with SFT, bold indicates the best performance in each column, and 1 denotes higher is better.
] TTIMO-Melboume ] TMOToronto ] THMO-Florence
Methods | __ AbD REPLACE ‘DELETE | ADD REPLACE DELETE | ADD REPLACE DELETE
| Mod? APRT Mod? APRT Mod? APRT | Mody APRT Mod? APRT Mod] APRT | Mody APRT Mod? APRT Mod] APRT
Gemmadb 90021 02257 OIGOS 0129S 0.5899 O30E1 OUTED OBIS IPE O14ds OTE O05 O02 O3431 HOME ORT OIsOT a2E
TRAC (Qwens-Sb-emd) [Orie 04211 O:1605 0.2000 0.9580 4601 | LI98S 0.3602 0.13563 O06) 05071 SOO | 0013 03582 O.0787 01254 01519 0.2531
Uama31-fb-Instuct 20021 02805 oral O1358 0.2545 0260 D076) O77 DO7as O104S Ones O3e76 OOS 03081 0730 O128E 0.1834 0.2508
TRAG [KalM-Cemmad-Ib-emd) | 01184 03158 Odel7 0088 3680 O-3827 | 01077 O307T O.10K8 1343 02953 Odes | ddees 03550 0.1129 01120 O2I60 0.3003
‘Quen3-tb DUIS 03816 DOD Dood OST O37Oe DOPED O384E O11 194d 05095 OS1a7 ODED O30 0119 ess O.AeI8 03285
RAG (GPTtest-emd-Hlarge) [01579 04079 O.1111 O197S 460) 0.5195 [01077 0.523) O.iex2 02290 4859 0.5888 | 01027 Oa376 01301 01038 02553 O30?
Phis15b D316 09553 ogee 01295 0.1852 0.1852 00308 0.602 OSM) 1343 0.1176 03382 OSG 03107 OBIE 1266 O.1654 0.2441
RAG (Qwens-ab-emd) [otae7 0.2505 0.0088 O1605 02716 0.2063 | 40760 0.2023 dors Dice? 059295 O50 | 0712 0350 dome died 02272 O30)
istal-240 D184 0.5280 011728 02029 09910 03487 KE? 0.2908 DOME 1194 O61s O3ere 0123 O35<7 DOT D1437 0.1768 0207
RAG (CPT-text-emd-Slarge) | 0.1642 0.4868 0.1852 02469 0.4691 9.5062 | 0.1385 0.4154 0.1791 0.2090 0.3362 0.5204 | 0.1214 O4807 0.1688 02281 03251 9.4128
Quen DIV} 03047 011235 01859 03457 03051 DOEIS 02154 Oi1I04 1403 0.9500 0.3500 Doe O3419 00833 1311 OAe18 03318
4RAG (KaLM-Gemmas-12b-emd) | 0.1711 9.3826 0.2099 0.2222 9.3827 0.4568 | 0.1077 0.4615 0.2000 0.2687 0.4559 OSati | 01180 94551 0.1631 02180 93240 O.a184
rts DO7GD 0.2805 01111 1728 0460) S02 DOME? 0158 OHS 14ds OSA? O70 DOreT 03221 O62 01323 dale? Nase
Pevahok [OU512 02763 O1111 O1728 OBSS6 6173 | MOs1S O2I5¢ |.0806 01701 Oglre O7RD0 | 00T12 03002 0.0783 OlaiT 03813 dasi2
Deepseek- V3.2 DOGG 0.9026 O19SH 01728 0617S TORT OOISe OOGIS OOTAE O11 OSBG2 70s OOGE O2%4 DOMI O14 3745 Oaa77
TRAG (Qwens-Sb-emd) 0009) 0.3632 0.1728 02002 04260 7037 | L0TEO 0.1602 Olea? Dies? 0.6020 dosie | 007108 03619 Diet! O2l66 O82 0.505)
GPTee-mini 21074 O61ae 05959 05432 OST OSE 03505 O62 0509 OSE7? OMT ATOM OREM o69eH O5H7 Oatse OSI O61
sPeveahot [02105 e711 03210 5062 Oaded debe [O.9s98 07231 03781 03672 0.4020 7500 [A251 06019 03579 daze? O80 OEI0R
DeepSeeke R32 0.2769 Ou6i42 03457 5309 05926 Oesd 02462 0.7538 03284 4025 0.090 0795 01718 A708 03907 D4895 0.505 16292
ew-shot [02632 0.6074 04951 0.6096 OSA7S 6206 [O.2615 0.7385 0.3284 507s OS735 O.7R00| 11688 06019 0.3590 da7Ed 05181 0.6232
‘Gemmad-4b (sLoRA) 22368 05192 05959 4108 04921 oaSe 02000 a@000 O2NY O3791 Om aera O2o asl daisy OSIOR ows aTsI4
Ciamad./Ab-insiact (sLoRA) 02500 O.e083 0.3827 04321 O.6014 O7160 D215 Dee? 0467 05224 0.7647 08529 0.2695 4779 03735 16420 0.7300 07874
Qwens-t (:LoRA) 22632 06316 03580 Daaed 0.5900 D555 D185 O86 05194 D417) O47] 07059 02602 O6AVG 15633 O.64es 0.7008 07683

Note: For base LLMs, we only keep zero-shot and the best setting selected by the average

the Appendix for full results

Table 4: Comparison of different RAG settings on base LLMs, where
Borda denotes the Borda count, Rank is the final order induced by
Borda, A is the mean improvement over the zero-shot setting, and |
means lower is better.

of Mod across all datasets/operations due to limited space. Please refer to

Table 5: SFT results (LoRA vs. FullFT), where A denotes the relative
average change of FullFT over LoRA, indicate A > 0 (improve-
ment), and indicate A < 0 (no improvement).

Wahes | bane | ABD | weMLACE | DELETE | yy

type | RAGSetting (| MotiReation Accuracy | All Pass Rate | | edt APRT | edT APRT | ModT APRT |
[Rank| Bordat AT [Rank| Bordat AT Melbourne | 0.1974 0.5658 /02716 0.3086 | 05679 05802) 14.2%
Gemmas-teullet| “Toronto [0.2023 16615) oas2r 0352008504 ae18| «18.6%
Random | Fewshot | 920 sermm| 5855 +348 Plovenee [0.2155 0019] a4872 os34a [os18 o7els| <.0%
Spasse | Bint [ses sean | ¢  to6e +568 Welbourne | 02532 0.4916 | 0868 04955 06667 O7037| «4.3%
Getistenddage | a tao saan] aos aS35e amas. 1-b-Fulet| "Toronto |o.2Ts0 0.8308] 08075 ose72 foser! orsa7| 20m
Dense |Katiemnd-Gemmaiae] 3 1720 e300] 3 i710 sae Florence [o.2ser osrse| 03621 veasa [orss7 07983) 03%
Qwememd- Bb 2 1735 s4aon| 2 tro s5a7% Melbourne | 0.2763 0.6711/04444 05185 | 0.6667 0.6790) 417.0%
Qvensab-ruilt | “Teronto. [02769 0.8789 [oav2s o5o70| 07353 08380 26.8
enhances performance, with dense retrieval consistently yielding the Plocence |0.2835 0.7153] os066 0780 07300 07728] 13.9%

most substantial improvements compared to other methods.

LoRA vs. Full Fine-Tuning (RQ3). In this part, we investigate
the influence of different SFT paradigms, ie, parameter-efficient
LoRA vs. full fine-tuning (FullFT). Table 5 reports the experimental
results. We observe that FullFT generally outperforms LoRA on
smaller datasets like Melbourne and Toronto. However, this per-
formance gap narrows significantly on the large-scale Florence
dataset. We attribute this observation to the sufficiency of low-rank
updates in data-abundant scenarios. With more training instances,
LoRA effectively captures the necessary task adaptations without
requiring updates to the entire parameter space. In conclusion, we
can answer RQ3: FullFT is preferable in data-scarce scenarios for
superior adaptability, whereas parameter-efficient LoRA serves as a
competitive and resource-efficient alternative as data scale increases.
Effects of incorporating RAG and SFT (RQ4). Since SFT and
RAG individually enhance base LLMs, we explore their synergis-
tic potential to answer RQ4. We initially fine-tune three LLMs
with zero-shot prompts. During inference, we augment the sys-
tem prompts with examples retrieved via various RAG settings.
However, Table 6 reveals that applying RAG to these zero-shot
SFT models often causes performance degradation. We hypothesize
this is due to the misalignment between the training (zero-shot)
and inference (few-shot/RAG) formats. To validate this, we employ

Table 6: Effects of various RAG settings on LLMs with SFT, where A
reports the mean change over the corresponding zero-shot settings.

Trad] Fe

ot Train) [Alignment (Tran)

Backbone | RAG Setting (Inference) |

Amod T Sarr T]Anod T Sarr T]Amoa T Aspe T

Few-shot “43% SEGRE ATR SER TE
Gemma3-4b | Hint Sh 329% dk 425m 17 aa
(lata) | CPT testemd acge “Shan BOSE 443% tex 1149 Lee
KaLM-Gemmai-l2bemd | 30.1% 318% 475% 479% 435m 42.3%
Queen3-Bb-emd “388% 200% 4an SIR ISI em

Few-shot “ile Tee Ole SR Om sO

LLlama3.1-ab | Bin “Sm Sam SOR asx 9m wae
{eaRA) | | CPT testemd acge “08% TSK 22% teOR aR BR
KaLM-Gemmai-l2bemd | 101 128 12m 48.9% Adm 41 3H
Queen3-Bb-emd ee es ee ee

Few-shot Se

Quend-Bb | Hint ey mr reer er
GPT-text-emd-large 33% B2n 411% 49.0% s462% 411.1%

(LoRA) | KalM-Gemmad-12b-emd | 87% 34% 47.2% 44.m  4180R 413.9%
Queend-fbeemd 47% 40 45x 86x 207% Laan

two strategies: fine-tuning with generic few-shot prompts, and an
"Alignment" strategy where training instances utilize the identical
retrieval settings used at inference. The results in Table 6 show that
both strategies restore performance gains, confirming the necessity
of consistency. Consequently, we answer RQ4: naively combining
SFT and RAG does not always guarantee improvements, and prompt
alignment between training and inference is essential.

===== page-07.png =====

iTIMO: An LLM-empowered Synthesis Dataset for Travel Itinerary Modification

7 Conclusion and Future Work

This paper introduces itinerary modification as a novel and criti-
cal task within the TRS domain. Accordingly, we propose iTIMO
datasets, constructed by leveraging LLMs to perturb real-world
itineraries thereby generating need-to-modify itineraries for mod-
ification. Moreover, we conduct comprehensive experiments to
benchmark current advanced LLMs’ performance in {TIMO. We
anticipate our dataset and benchmarking results will serve as a
valuable resource for advancing research in TRS community.
However, our study remains certain limitations that suggests
directions for future work. Regarding the dataset, the generation
of need-to-modify itineraries is currently user-agnostic and relies
onthree high-level intents. Furthermore, due to the inaccuracy of
temporal information in the source data, our perturbation process
does not account for temporal features. Future research could incor-
porate user simulation [44] and integrate temporal constraints to
provide richer contexts and more realistic scenarios. Methodologi-
cally, our results identify SFT as a promising approach for this task.
Subsequent studies might design advanced reinforcement leaming-
based fine-tuning paradigms to further enhance performance.

Acknowledgments

This work is partially supported by National Natural Science Foun-
dation of China under Grants 71971221 and 62477009, Natural Sci-
ence Foundation of Hunan Province under Grant 2025JJ50419, Major
Scientific and Technological Innovation Platform Project of Hunan
Province under Grant 2024JC 1003, and Changsha Natural Science
Foundation of China under Grant kq2502127. It is partially sup-
ported by the Ministry of Education, Singapore, under its MOE
AcRF Tier 1, SUTD Kickstarter Initiative (SKI 2021_06_12).

References

[1] Marah Abdin, Jyoti Anja, Harkirat Behl, Sébastien Bubeck, Ronen Eldan, Suriya
Gunasekar, Michael Harrison, Russell J Hewett, Mojan Javaheripi, Piero Kaulf-
mann, et al. 2024. Phi-d technical report. arXiv preprint arXiv:24 12.08905 (2024),

[2] Ashmi Banerjee, Adithi Satish, Fitri Nur Aisyah, Wolfgang Wérndl, and Yashar
Deldjoo. 2025. SynthTRIPs: A knowledge-grounded framework for benchmark
data generation for personalized tourism recommenders. In Proceedings of the 48th
International ACM SIGIR Conference on Research and Development in information
Retrieval. 3743-3752,

[3] Tom Brown, Benjamin Mann, Nick Ryder, Melanie Subbiah, Jared D Kaplan,
Prafulla Dhariwal, Arvind Neelakantan, Pranay Shyam, Girish Sastry, Amanda
Askell, et al 2020. Language models are few-shot learners. Advances in Neural
Information Processing Systems 33 (2020), 1877-1901

[4] Shihao Cai, Jizhi Zhang, Keqin Bao, Chongming Gao, Qifan Wang, Fuli Feng, and
Xiangnan He. 2025. Agentic feedback loop modeling improves recommendation
and user simulation. In Proceedings of the 48th international ACM SIGIR conference
on Research and Development in information Retrieval. 2235-2244

[5] He Chang, Chenchen Ye, Zbulin Tao, Jie Wu, Zhengmao Yang, Yunshan Ma,
Xianglin Huang, and Tat-Seng Chua. 2024. A comprehensive evaluation of large
language models on temporal event forecasting. arXiv preprint arXiv:2407. 11658
(2024).

[6] Sournyabrata Chaudhuri, Pranay Purkar, Ritwik Raghav, Shubhojit Mallick, Man-
ish Gupta, Abbik Jana, and Shreya Ghosh, 2025. Tripcraft: A benchmark for
spatio-temporally fine grained travel planning. arXtv preprint arXiv:2502,20508
(2025).

[7] Aili Chen, Xuyang Ge, Ziquan Fu, Yanghua Xiao, and Jiangjie Chen. 2024
‘Travelagent: An Al assistant for personalized travel planning. arXiv preprint
arXiv 2409, 08069 (2024).

[8] Lei Chen, Jie Cao, Weichao Liang, and Qiaolin Ye. 2024. Geography-aware
heterogeneous graph contrastive learning for travel recommendation. ACM
Transactions on Spatial Algorithms and Systems 10, 3 (2024), 1-22

[9] Lei Chen, Jie Cao, Haicheng Tao, and Jia Wu. 2023. Trip reinforcement rec-
commendation with graph-based representation learning. ACM Transactions on
Knowledge Discovery from Data 17, 4 (2023), 1-20

2]

03]

v4]

5]

be]

7]

8]

9]

[20]

(21]

(22)

(23)
(24)

(25)

(2)

(27)

[28]

(29)

(30)

[31]

32]

3]

[34]

Conference acronym "XX, June 03-05, 2018, Woodstack, NY

Lei Chen, Guixiang Zhu, Weichao Liang, and Youquan Wang. 2023. Multi-
objective reinforcement learning approach for trip recommendation. Expert
Systems with Applications 226 (2023), 120145.
Wei Chen, Yuxuan Liang, Yuanshao Zhu, Yanchuan Chang, Kang Luo, Haomin
Wen, Lei Li, Yanwei Yu, Qingsong Wen, Chao Chen, et al. 2024. Deep learning for
trajectory data management and mining: A survey and beyond. arXiv preprint
arXiv.2408, 14151 (2024),
DeepSeek-Al Team. 2025. Introducing DeepSeek-V3.2-Exp. DeepSeek API Docs
News. httpsi//api-docs deepseek.com/news/news250929
Bin Deng, Yizhe Feng, Zeming Liu Qing Wei, Xiangrong Zbu, Shuai Chen,
Yuanfang Guo, and Yunhong Wang. 2025. Retail: Towards real-world travel
planning for large language models. arXiv preprint arXiv:2508 15535 (2025)
Abhimanyu Dubey, Abhinay Jauhri, Abhinav Pandey, Abhishek Kadian, Ahmad
Al-Dable, Aiesha Letman, Akhil Mathur, Alan Schelten, Amy Yang, Angela Fan,
et al, 2024. The Hama 3 herd of models. arXiv preprint arXiv:2407 21783 (2024),
Peter Emerson. 2013. The original Borda count and partial voting. Social Choice
and Welfare 40, 2 (2013), 353-358.
Kenneth Enevoldsen, Isaac Chung, Imene Kerboua, Marton Kardos, Ashwin
Mathur, David Stap, Jay Gala, Wissam Siblini, Dominik Krzemifiski, Genta Indra
Winata, et al. 2025. MMTEB: Massive multilingual text embedding benchmark,
arXiv preprint arXiv:2502, 13595 (2025).
Fuli Feng, Xiangnan He, Yiqun Liu, Ligiang Nie, and Tat-Seng Chua. 2018. Learn-
ing on partial-order hypergraphs. In Proceedings of the 2018 World Wide Web
Conference. 1523-1532,
Ines Gasmi, Makram Soui, Khaoula Barhoumi, and Mourad Abed. 2024. Rec-
commendation rules to personalize itineraries for tourists in an unfamiliar city.
Applied Soft Computing 150 (2024), 111084
Runquan Gui, Zhihai Wang, Jie Wang, Chi Ma, Huiling Zhen, Mingxuan Yuan,
Jianye HAO, Defu Lian, Enhong Chen, and Feng Wu. 2025. HyperTree planning:
Enhancing LLM reasoning via hierarchical thinking. In Proceedings of the 42nd
International Conference on Machine Learning.
Daya Guo, Dejian Yang, Haowei Zhang, Junxiao Song, Ruoyu Zhang, Runxin
Xu, Qihao Zhu, Shirong Ma, Peiyi Wang, Xiao Bi, et al. 2025. Deepseek-rl:
Incentivizing reasoning capability in IIms via reinforcement learning. arXiv
preprint arXiv:2501.12948 (2025).
Yilun Hao, Yongchao Chen, Yang Zhang, and Chuchu Fan. 2025. Large language
models can salve real-world planning rigorously with formal verification tools
In Proceedings of the 2025 Conference of the Nations of the Americas Chapter of the
Association for Computational Linguistics: Human Language Technologies (Volume
4: Long Papers) 3434-3483
Edward J Hu, Yelong Shen, Phillip Wallis, Zeyuan Allen-Zhu, Yuanzhi Li, Shean
Wang, Lu Wang, and Weizhu Chen, 2022. LoRA: Low-rank adaptation of large
language models. In Proceedings of the International Conference on Learning
Representations (ICLR) httpsi//openreview net/forum?id=nZeV KeeFYF9
Lucien Le Cam and Grace Lo Yang. 2000. Asymptoties in statisties: Some basic
concepts. Springer Science & Business Media,
Erich Leo Lehmann and Joseph P Romano, 2005. Testing statistical hypotheses
Springer.
Patrick Lewis, Ethan Perez, Aleksandra Piktus, Fabio Petroni, Vladimir Karpukhin,
Naman Goyal, Heinrich Kittler, Mike Lewis, Wen-tau Yib, Tim Rocktaschel,
Sebastian Riedel, and Douwe Kiela 2020. Retrieval-augmented generation for
knowledge-intensive NLP Tasks. In Advanees in Neural information Processing
Systems (NeurlPS 2020). httpsi//praceedings.neurips.cc/paper/2020/hash/6b493,
230205F780e1bc26945d°7481e5-Abstract html
Kwan Hui Lim, Jeffrey Chan, Christopher Leckie, and Shanika Karunasekera,
2015, Personalized tour recommendation based on user interests and points of
interest visit durations. In Proceedings of the 24th international Conference on
Artificial Intelligence. 1778-1784
Jianbua Lin, 2002. Divergence measures based on the Shannon entropy. /EEE
Transactions on Information theory 37, 1 (2002), 145-151
Aisin Liu, Bei Feng, Bing Xue, Bingxuan Wang, Bochao Wu, Chengda Lu, Cheng-
gang Zhao, Chenggi Deng, Chenyu Zhang, Chong Ruan, et al. 2024. Deepseek-v3
technical report. arXiv preprint arXiv:2412 19437 (2024).
Mistral Al. 2025. Mistral small 3. Mistral Al News. httpsi/mistral ai/news/mistral-
small-3
Cristina Ioana Muntean, Franco Maria Nardini, Fabrizio Silvestri, and Ranieri
Baraglia 2015, On learning prediction models for tourists paths. ACM Transac-
tions on Intelligent Systems and Technology (TIST) 7, 1 (2015), 1-34
Hang Ni, Fan Liu, Xinyu Ma, Lixin Su, Shuaigiang Wang, Dawei Yin, Hui Xiong,
and Hao Liu 2025. TP-RAG: Benchmarking retrieval-augmented large lan-
‘guage model agents for spatiotemporal-aware travel planning. arXiv preprint
arXiv:2504,08694 (2025).
OpenAl, 2024. GPT-4.1. https://platform openai.com/docs/modelstgpt-4.1. Large
Tanguage model accessed via OpenAl API
OpenAl. 2024. text-embedding-3-large (Model documentation}. https.//platform
‘openai.com/docs/models/text-embedding-3-large. Accessed 2025-12-15.
QpenAl. 2025. o4-mini Model (QpenA] AP] Documentation). https://platform.o
penai.com/docs/models/od-mini Accessed: 2026-01-08.


===== page-08.png =====

Conference acronym "XX, June 03-05, 2018, Woodstock, NY

[35] Yincen Qu, Huan Xiao, Feng Li, Hui Zhou, and Xiangying Dai, 2025. TripScore:
Benchmarking and rewarding real-world travel planning with fine-grained eval-
uation, arXiv preprint arXiv:25 10.0901 1 (2025),

[36] Jie-Jing Shao, Bo-Wen Zhang, Xiao-Wen Yang, Baizhi Chen, Si-Yu Han, Wen-Da
Wei, Guobao Cai, Zhenhua Dong, Lan-Zhe Guo, and Yu-feng Li. 2024. China-
‘Travel: An open-ended benchmark for language agents in Chinese travel planning
arXiv preprint arXivi2412 1682 (2024),

[37] Zijian Shao, Jiancan Wu, Weijian Chen, and Xiang Wang. 2025. Personal travel
solver: A preference-driven LLIM-solver system for travel planning. In Proceedings
of the 63rd Annual Meeting of the Association for Computational Linguistics (Volume
1: Long Papers). 27622-27642.

[38] Roger W Sinnott. 1984. Virtues of the Haversine. Sky and telescope 68, 2 (1984),
158.

[39] Yihong Tang, Zhackai Wang, Ao Qu, Yihao Yan, Zhaofeng Wu, Dingyi Zhuang,
Jushi Kai, Kebing Hou, Xiaotong Guo, Jinhua Zhao, et al. 2024. ItiNera: Integrating
spatial optimization with large language models for open-domain urban itinerary
planning. In Proceedings of the 2024 Conference on Empirical Methods in Natural
Language Processing: industry Track. 1413-1432.

[40] Gemma Team, Aishwarya Kamath, Johan Ferret, Shreya Pathak, Nino Vieillard,
Ramona Merhej, Sarah Perrin, Tatiana Matejovicova, Alexandre Ramé, Morgane
Riviere, et al. 2025. Gemma 3 technical report. arXiv preprint arXivi2503.19786
(2025).

[41] Bart Thomee, David A Shamma, Gerald Friedland, Benjamin Elizalde, Karl Ni,
Douglas Poland, Damian Borth, and Li-Jia Li, 2016. Yfecl00m: The new data in
multimedia research. Commun. ACM 59, 2 (2016), 64-73.

[42] Kaimin Wang, Yuanzhe Shen, Changze Ly, Xiaoging Zheng, and Xuan Jing Huang,
2025. Triptailor: & real-world benchmark for personalized travel planning. In
Findings of the Association for Computational Linguistics: ACL 2025, 9705-9723.

[43] Xiaoting Wang, Christopher Leckie, Jeffrey Chan, Kwan Hui Lim, and Tharshan
Vaithianathan. 2016. Improving personalized trip recommendation by avoiding
crowds. In Proceedings of the 25th ACM international on conference on information
and knowledge management. 25-34

[44] Tianjun Wei, Huizhong Guo, Yingpeng Du, Zhu Sun, Chen Huang, Dongxia Wang,
and Jie Zhang. 2025. Mirroring users: Towards building preference-aligned user
simulator with user feedback in recommendation, arXiv preprint arXiv.2508, 18142
(2025).

[45] Qianfeng Wen, Yifan Liu, Joshua Zhang, George Saad, Anton Korikov, Yury
Sambale, and Scott Sanner. 2024. Elaborative subtopic query reformulation for
broad and indirect queries in travel destination recommendation. arXiv preprint
arXiv 2410,01598 (2024).

[46] Jian Xie, Kai Zhang, Jiangjie Chen, Tinghui Zbu, Renze Lou, Yuandong Tian,
Yanghua Xiao, and Yu Su, 2024. TravelPlanner: A benchmark for real-world
planning with language agents. In Proceedings of the 4 Ist international Conference
on Machine Learning. 54590-54613.

[47] An Yang, Anfeng Li, Baosong Yang, Beichen Zhang, Binyuan Hui, Bo Zheng,
Bowen Yu, Chang Gao, Chengen Huang, Chenxu Ly, et al. 2025. Qwen3 technical
report. arXtv preprint arXiv.2505. 00388 (2025).

[48] Dongjie Yang, Chenggiang Lu, Qimeng Wang, Xinbei Ma, Yan Gao, Yao Hu, et al
2025. Wide-horizon thinking and simulation-based evaluation for real-world
LLM planning with multifaceted constraints. In Proceddings of the 39th Conference
on Neural Information Processing Systems.

[49] Qing Yin, Hui Fang, Zhu Sun, and Yew-Soon Ong 2023. Understanding diversity
in session-based recommendation, ACM Transactions on Information Systems 42,
1 (2023), 1-34

[50] Yuguo Yuan and Weimin Zheng 2024. Your trip, your way: An adaptive tourism
recommendation system. Applied Soft Computing 154 (2024), 111330.

[51] Hongyu Zhang, Zhuoxuan Huang, Zixu Jiang, Hua Ma, and Haibin Zhu, 2024
Collaborative route planning of road trips in regional central cities of China: An
approach based on E-CARGO model. /EEE Transactions on Computational Social
Systems 11,5 (2024), 6347-6365,

[52] Yanzhao Zhang, Mingxin Li, Dingkun Long, Xin Zhang, Huan Lin, Baosong
Yang, Pengjun Xie, An Yang, Dayiheng Liu, Junyang Lin, et al. 2025. Qwen3
embedding: Advancing text embedding and reranking through foundation odels,
arXiv preprint arXiv:2506 05176 (2025),

[53] Zhihan Zhang, Yixin Cao, Chenchen Ye, Yunshan Ma, Lizi Liao, and Tat-Seng
Chua. 2024. Analyzing temporal complex events with large language models? A
benchmark towards temporal, long context understanding. In Proceedings of the
62nd Annual Meeting of the Association for Computational Linguistics (ACL 2024):
Bangkok, Thailand, August 11-16,

[54] Xinping Zhao, Xinshuo Hu, Zifei Shan, Shouzheng Huang, Yao Zhou, Xin Zhang,
Zetian Sun, Zhenyu Liu, Dongfang Li, Xinyuan Wei, etal. 2025. Kalm-embedding-
v2: Superior training techniques and data inspire A versatile embedding model
arXiv preprint arXiv:2506 20923 (2025),

[55] Tao Zhe, Rui Liu, Fateme Memar, Xiao Luo, Wei Fan, Xinyue Ye, Zhongren Peng,
and Dongjie Wang. 2025. Constraint-aware route recommendation from natural
Tanguage via hierarchical LLM agents. arXiv preprint arXiv:2510.06078 (2025).

Huang et al.

A Appendix

A.1 Dataset Preprocessing

As previously mentioned, our iTIMO datasets are constructed from
public travel datasets covering Toronto [26], Melbourne [43], and
Florence [30]. We preprocess these datasets as follows. First, itineraries
with lengths less than 3 are removed to enable the execution of
the DELETE perturbation operation. Second, the Florence dataset
contains several itineraries with excessive lengths (e.g., 164 POIs),
which are impractical for realistic planning. This issue arises from
inconsistent definitions of an itinerary during data collection. Specif-
ically, itineraries in the Melbourne and Toronto datasets are con-
strained by a total duration of less than 10 hours, whereas the
Florence dataset only requires the interval visiting time between
adjacent POIs to be less than 6 hours. To address this, we use a
sliding window to truncate long itineraries in the Florence dataset.
‘The window size is set to 21, consistent with the maximum itinerary
length observed in the Melbourne and Toronto datasets.

Table 7: Training hyperparameters for SFT LLMs.

Hyperparameter. Gemma3—Llama3 Quen3

LoRA Full LoRA Full LoRA Full
epoch 2.0 2.0 2.0 2.0 2.0 2.0
batch_size 4 4 4 4 4 4

Jeaming rate 5«10 1x10 $x10 1x10 5x10 1x10
weight decay 0.01 0.00 0.01 0.01 0.01 0.01
warmup_step 30-3030 30 8030

Ir_scheduler
max_grad_ norm 05 05 05 05 05 05

cosine cosine linear linear linear linear

A.2. Implementation Details

For these base LLMs, we set the temperature to 0 for fixed output. Re-
garding the LRMs, their temperatures are not allowed to adjust and
we use their default settings. In terms of the SFT LLMs, we set the
maximum of context length to 8192 and AdamW is selected as the
optimizer. For the remaining parameters, grid search is conducted to
find the optimal settings. Specifically, the training epoch is selected
from [1.0,2.0,3.0], batch size is selected from [4, 8, 16], learning rate
is selected from [1x107®, 2x107®, 5x107®, 1x1075, 5x1075], weight
decay is selected from [0.0, 0.01], warm-up step is selected from
[10, 30], learning rate scheduler is selected from [cosine, linear],
and the threshold for gradient dlip is selected from [0.5, 1.0]. Due to
the substantial computational overhead of grid search, we prioritize
the validation set of the ‘TIMO-Melbourne dataset for hyperparam-
eter tuning. Specifically, we focus on the ADD operation, which
represents the most challenging itinerary modification task. As a
result, the hyperparameter settings are shown in Table 7.

A.3 Tool Box for our V3.2 FM
The tool box used in our V3.2 FM is introduced in Table 8.

A4 Detailed Results for RQ1 & RQ4

The detailed results about LLM’s performance in the itinerary mod-
ification task are displayed in Table 9 and Table 10, respectively.

===== page-09.png =====

iTIMO: An LLM-empowered Synthesis Dataset for Travel Itinerary Modification

Table 8: Tool box of itinerary perturbation for our V3.2 FM.

Function

Purpose

geo_distance_segments

Computes consecutive spatial distances
between adjacent POls and discretizes
each segment into low/medium/high
classes for original and perturbed
itineraries.

stats_from_categories

Given categorical label sequences (e.g.,
popularity labels or spatial segment
classes) of original and perturbed
itineraries, computes distribution shift
(Hellinger) and rank stability (Kendall's
Tau-b), then retums a thresholded
disruption decision.

cd_from_categor ies

Computes category diversity (CD) of
original and perturbed itineraries using
case-insensitive unique categories and
outputs whether the CD ratio changes
(CD disruption).

categories_from_itinerary

Extracts the POI category from each
itinerary to avoid free-text parsing.

AS Prompt Template

For the baseline methods (i.e., DeepSeek V3.2 and R3.2), the prompts
to guide them for itinerary perturbation are shown as box 1-3. For
our proposed V3.2 FM, the perturbation prompts are shown as box 4-

6. The template of memory module is shown as box 7. Furthermore,

the prompts used for itinerary modification are shown as box 8-10.

Conference acronym "XX, June 03-05, 2018, Woodstack, NY

===== page-10.png =====

Conference acronym "XX, June 03-05, 2018, Woodstock, NY Huang et al

Table 9: Itinerary modification performance across datasets, operations, LLMs, and RAG Settings, where | denotes LIM, denotes LRM,
denotes LLMs with SFT, bold scores indicate the best performance in each column, and underlined scores denote the optimal results within
specific models.

1 TTIMO-Melbourne 1 TIMO-Teronte 1 TTLMO-Flerence
Methods | ano) REPLACE DELETE | ADD REPLACE DELETE | ADD REPLACE DELETE

| moat pet Med? apRT Med! apRt | Med? Apel Mod? Apel Med! Apel |Med? Apel Med? Apel Med? apal

Gemmai-4b 00921 02257 OIG0S 0.1285 O53 U5951] O07 O21 0.1104 0.1403 O4I7e OS0SH 00723 03431 oN002 O12TT OISO7 ~n2A8E
“4Pew-shot B14a7 03047 OITIT 0.1481 0.2063 3580) 0.0815 0.2615 0.1194 0.1642 03529 gael? |0s02 0.2982 OOTTS O10e o1582 02475
RAG (Hint) OASIS 0280S 0148) 0.2000 H2a60 03333] 0.0023 03692 0.0149 O.J642 0270 0.9382 |o0sA 13002 HORT 01231 Dias 02508

RAG (GPTtext-emd-Slarge) | 0.1184 03421 01235 9.1728 02840 03580] 0.1231 0.3385 O.1542 0.2000 03529 9.4550 |oo735 03504 00950 0.1300 0.1620 7801
ARAG (KaLM-Germmas-I2b-emd)| 0.0921 9.2805 01358 0.1481 O3487 03051 | 9.1077 0.3077 OI343 0.1791 O3676 9.4853 |OORTT 03456 0008 OI1345 O1452 T2565

+RAG (Quen3-th-emd) O31 04211 0.1605 9.2009 9.3580 O4s01| 0138S 0.3692 0.1343 O.J040 93071 9.5000 |O07IS 03582 DOTET DID 01519 0231
Uama-3.1-ab-Instruct 0092 02895 0074 01588 02348 N2Ee0| O07 O07 O.OTAE 0.104 0478S 0.3678 00872 03081 OOTSD 0.1288 O.1834 02508
“Pew-shot 0789 02895 “ODE 0.0088 0.2063 03210] 000 0.3077 0.1048 0.1194 0.2353 dades |onea2 0.3232 DOTS O1277 02002 O2—a5T
RAG (Hint) 00789 0302 00617 0.0088 0.2840 03333) 0O462 0.2675 O68 0.0507 02050 Hades O07 13652 DOO 0.1129 0223 02058
4RAG (CPTtext-emd-Slarge) | 0.0858 0.2632 00404 0.1111 03210 03580] 9.0023 0.2615 0.0906 0.1343 OD500 O.4118 | 00770 03431 00719 0.1300 9.2395 03093,
RAG (KaLM-Germmas-I2b-emd) | 0.1184 03158 00617 9.0088 03580 03827 | 0.1077 0.3077 0.1045 0.1343 02353 O.a2s5 | Doss 03559 01120 T1129 H2160 03008,
+RAG (Quen3-th-emd) DOLE TIS 00404 00%e THF T3457 | OVI 03231 01343 O. 1949 02041 Vaal2|oorSS T3490 HOTS? TILT 0Das6 03028
‘Queen3-8b 1184 05816 00247 0.0404 03457 05704) O.OTED OSE4E 0.1194 0.1940 05235 OS147 00882 03967 0.1129 0.1683 02418 03285
*+Pew-shot 01316 03947 00088 0.1728 94601 O5185| 0.0769 0.276 0.0806 0.1403 94853 OS441 0.0033 OalOT 0.1380 0.1893 02250 03116
RAG (Hint) 147 04342 0.1111 0.1952 DAI OaBIS | 01231 O40 0.1343 O.J940 Tar 05147 [0.1050 1.4492 O40 01973 02305 03251
ARAG (CPT text-emd-Slarge) | 0.1579 94079 01114 O17 O46! 95185] 9.4077 0.3231 0.1542 0.2239 O4sS9 gSaR | 01027 D437 DITO 0.1938 0.553 9.3442
ARAG (KaLM-Gemma3-I2b-emd)| 01447 4211 01935 O48 D432 4038 | 9.0023 0.3231 0.096 0.4642 OaBs3 95882 |01190 oaso7 OI44g O05? D207 DIDI
RAG (Quen3-db-emd) 0.0021 OSGI TIT Oie0s 93807 Oaase| 00023 03385 0.1940 9.7988 TANSs TSG |TV Tass? 0134 TIGG! 02160 03161
Phie 5b ISIE 95583 0084 0.1285 041852 01852] 0O90R 0.1692 0.0507 0.1343 0.4176 0.3382 0084S 03197 ONEIE O1266 O1eB4 O24a1
+Pew-shot 00789 DIE o.1481 9.2000 0271 02063] 00462 0.1692 0.0746 0.1791 O.4618 0.3971 00630 O3606 DOTE O1as7 02171 02970
4RAG (Hint) 0.1053 03025 “DoR6d DING 02508 O30RE| 0.0769 0.1692 0.0906 D.I64 O17 0.3676 [OOK 13512 D604 0120 02013 02866

ARAG (CPT text-emd-Slarge) | 0.1184 0315 01295 OF605 02503 o2Re0 | 0.0003 ODIs Does 0.1045 02353 4412 |Do7K2 OS67E HORA Oi44s 09951 93116

4RAG (KaLM-Gemma3-I2b-emd)| 0.1184 0342 00741 0.1235 02503 o2Re0 | DO30R 0.1692 080s 0.1701 02353 O.al1a |Ooss0 OssDe Dore? O130 D203 03005

+RAG (Quen3-th-emd) BIT 02805 0098 0.1605 G71 02063] 0.0769 9.2023 Doras OJ64? 03235 0.8204 |O07I2 03504 DORM NIa4s 02272 03071
Misteal-246 1184 05269 01728 0.222 05210 US4S7 | 0.04E2 0.2308 0.080E 0.1194 O4EIS O.S6TH 00723 O384T ONSET O1497 OLITEH 02497
+Pew-shot O1184 03664 01358 0197S Oaae oases | 0.0023 03077 O.0746 0.1194 02353 Oaal2 O0817 O4037 0.1243 1813 02610 03510
RAG (Hint) 01316 03853 01605 9.2503 Sasa 04815 | 0.0023 0.3692 0.1045 0.1791 03520 OSa4i ]01062 14095 Dial 016) O26AR 03555

4RAG (CPT text-emd-Slarge) | 0.1942 O4l6G 01852 Tas O46! o5062| 0.1385 Halse 0.1701 0.2000 03382 TH0E |0I9I4 O4gO7 O1688 0278 03251 D4128

4RAG (KaLM-Gemma3-I2b-emd)| 01316 D381 O160S 0.2450 o46oi oso62| D177 O3s46 0.2388 03134 03924 O.5G00 /OTI7O OaSra OI8Si O2i2i O31%6 03870

+RAG (Quen3-th-emd) HIST 04079 01481 0.2002 HaRIs o54R5| 01385 O41 0.1403 0.2230 03382 0.5000 |01085 dass OISI7 02260 03048 OSR—r
‘Qveen3-22b DAT 03947 01235 0.1852 03457 03951] 0081S 0.21% 0.1194 0.1403 02500 0.3829 Ooese 03419 00833 0.41311 O2418 03318
tPew-shot 0.2368 05152 01481 0.1975 O48) 05670 | 0.0023 0.3846 0.1343 0.1791 O4118 OBaai 00793 O4026 0.110 0.1668 03273 Dale?
4RAG (Hint) DIST OS0O 0.1852 9.2460 D3OSF GaBTs | 01231 0.1231 0.1493 0.2030 O414R OS147 01020 dara7 9.4200 1688 02081 OSRe7

RAG (CPT text-emd-Slarge) | 0.1579 9.4605 01852 O17 03704 04501 | 0.1602 alse 0.1940 0.2085 oasso oS735 |01121 O4ad2 OISS1 9.2018 03251 Dad!
4RAG (KaLM-Germma3-I2b-emd)| 0.1711 05526 02000 0.2202 03807 oasea| TIT Oasis 0.2000 O6aT OAS Hai |01180 O4S51 01631 02180 03240 D4isE

+RAG (Quen3-th-emd) O36 0432 0172 0.2000 O3R27 o4s6a| 0.0023 D430 O.f045 0.2030 T3676 v.2853 | O11 Teas! DIS7a D266 03866 04376
cera DOTS 02895 0171) 01728 O4G9T OSN62| O.04G2 0.138 ORE 0.1403 OSGR2 H7SON OOTaT 03221 ONEE2 0.1323 D4162 nARsE
+Pew-shot 1312 02763 01111 0.1728 O558 O6173| 00615 0.21% 0.0806 0.1791 OB17e H.79O0 /00712 03092 OATS O1asT D383 Dasle
+RAG (Hint) 0.0658 0265 01235 0.1952 Dade TARTS | 0.0615 0.2000 0.1403 0.2030 TSaal THVI2 | ORS 1317 0.0605 01345 02767 03453
ARAG (CPT text-emd-Slarge) | 0.0526 0.2762 OOSIT 0.1605 O41 o4s68| 9.1077 0.2760 0.1542 0.2000 O54! 9.7205 |OO770 03209 00903 ai642 03127 03003,
ARAG (KaLM-Germmas-I2b-emd)| 0.0921 93280 01111 0.7202 aor 04321 | 9.0023 0.2000 0.1194 0.2000 o6i76 0.7953 |00758 03361 DORAs T1505 03183 03037
+RAG (Quen3-th-emd) BASS 03047 00088 TIBI Sasa 04501 | VwTT 0.2023 O.170) O37 Taal Ve7Es [O07 T3314 0.005 O1608 03746 04400
DeepSeek-¥3.2 DOGG 05026 01558 01728 OBITS OTUST| OOISA ON6I 0074S 0.1194 OSSR2 0.7059 O0ES 02984 OND O.1404 OSTAR NAAT
+Pew-shot 00789 22500 0008S 0.1605 05802 6543 | 0.0308 0.1077 0.1343 0.1343 06029 0.6012 |ao7T0 0.3372 0.1026 OSE Dadse 05958
RAG (Hint) 0.0789 03025 0.111 01605 95802 06867 | 00308 0.1077 0.0806 0.1343 OS441 05735 ]00712 13326 9.008) 01642 0.4573 05300

4RAG (CPT text-emd-Slarge) | 0.0789 0.2500 0.1481 0.1728 05925 Os667 | 9.0760 O.1845 0.1403 0.1403 06324 9.6012 |00010 O3547 01987 1916 D490 O75
ARAG (KaLM-Gemmas-I2b-emd) | 0.1184 0.2805 01235 9.1605 06173 98014 | TO000 OIOTF 01045 0.1343 o6618 0.7953 |DoRE O34 01186 O1767 dara? 95624
9

+RAG (Quen3-th-emd) DOI 026 01728 9.2002 Hered O7O3T| VOTE) 0.1692 O.M642 O.J64? THON Veols (00723 13419 Dia7i O2165 05242 05051
SPT-ot-mini 1974 O61 03333 S482 0567 O6543 | 0.3385 0602 OMIS ON6T2 OBAT O.7041 O2E14 O69K 039627 DANSE OSISN 06142
#Pew-shot 2105 O67! T3210 DEO osoa9 esas | 03838 0.7281 0.9731 THEI? THD HISD [OTS TID 03879 4242 DETOT o6t0—
DeepSeek-R3.2 02763 06842 03457 05309 05028 06843 | 0ME2 0.793 05284 0.4025 06029 0795S OATIS 0708S 03307 HAEss a5259 06232
*tPew-shot 012632 0.6974 0.3991 0.6296 OSETS 06206 [0.2613 0.7385 0.5284 0.507 05735 0.7500 [01688 06919 033% OATS 05181 06232
‘Gemma3-tb (+LeRA) 02568 95152 03933 94198 04321 ASEH] 0.2000 0.6000 0.2085 0.9731 06029 OLETEs O2I7TE nee1s OaséT OSI08 OSOS OTEIA
“Pew-shot O1184 O47) “Qlad] O1.1TS 02068 03933 | 0.1231 0953 0.0806 0.1791 03971 OASS0 /OIE10 05228 D2 02780 aA0% O50SI
RAG (Hint) O13 03421 0197S O2%6 O2460 03457 | O2IS4 O07 0.4045 0.1493 94850 O5000 | 01622 05321 O46 O30M Oar 0526

ARAG (CPT text-emd-Slarge) | 0.1942 03047 01728 0.1852 02063 03704 | DT53E ads? 0.1940 0.2085 03235 Halsa |oJsas 05309 02972 03087 Dale 05120
RAG (KaLM-Germma3-I2b-emd)| 0.1316 03553 01235 9.1852 0280 03333 | 0.1077 O44sD 0.2030 0.2687 Oars 9.4853 | 01680 O5854 02383 A208 D421 05051
+RAG (Quen3-th-emd) O.1447 03816 01958 0.1728 2840 04321 | 01692 O476 0.9988 0.384 03088 0.3071 [OES 15438 04881 O2a86 03532 O4SEr

Llama i-ib-Instruct @LORA) | 0.2500 6053 03827 0.4321 0.6914 0.7160] 0.2154 5462 04507 05224 0.7647 0.8529 02605 06779 05735 O5420 07300 OTETE
Pew-shot D262 DeadT 03333 D301 O04 os420 [0.2613 OATH 03134 TAOS 08912 v.7E47 [02009 OESIE DATD TSE O71 OTT
+RAG (Hint) Diora TST 0.2627 9.4038 OR02 06206] 01385 0553 03582 04328 O664R 0.7353 /02200 deaal OSI O50 07152 07683

4RAG (CPT text-emd-Slarge) | 0.2368 95780 03333 03051 05025 5420 | 9.2308 0.6000 0.3881 O4776 06618 0.7205 |o2485 Hoss OS017 05838 0.7120 07672
RAG (KaLM-Germmas-I2b-emd) | 0.2405 95526 02503 0.3704 05925 05206 | 0.2308 0.6452 D452? 05024 07206 0.7704 |02357 Osea! 04003 OSee7 D708 07548

+RAG (Quen3-th-emd) 0.2500 05658 03580 04198 95185 OS679| 02000 TEU TATE THT 07500 V.wUSR [O24 AETSE O01 OSI 060 07570
‘Queen3-Bb (+LeRA) 02632 06316 03580 Dad 05300 OSNSE| 0.1848 OEM 0.9134 04179 O8471 0.7059 012602 06806 05633 DEABR 0.7098 07683
tPew-shot O12 06083 02346 0260 O55 05926 | 0.1231 OS0TT 0.9537 0.5284 06324 0.7089 /012065 06280 D407! S872 06535 07190
4RAG (Hint) 0.2026 618 03210 0.4198 05802 05490] 0.1385 9.4923 9.5881 04328 06324 0.7059 10.1905 0.6231 D4dIe OSBOL O66? O 7244

ARAG (CPT text-emd-Slarge) | 0.2500 05021 03951 0.4321 05679 D205 | 0.1538 05231 0.3433 0.3881 O6176 Ores |02217 O6418 05005 05838 06398 Oro
4RAG (KaLM-Gemma3-I2b-emd)| 0.1074 05526 D347 0.3827 05432 08173/ 9.1077 05538 4030 OaTE Noa! O.7500 |02124 Ooee! 04983 A580 OoasT O.6502
4RAG (Qwen3-th-emd) 0.2937 O57H 03210 dao7e 95026 sara] 01538 OOTY 03881 O47 OsI76 0.6012 [02220 06313 950% 05TH 08ST O70RT


===== page-11.png =====

iTIMO: An LLM-empowered Synthesis Dataset for Travel Itinerary Modification Conference acronym "XX, June 03-05, 2018, Woodstack, NY

Table 10: Effects of various RAG settings on LLMs with SFT, where A denotes the relative performance improvement over the zero-shot inference
baseline for the same model. Cells shaded with indicate A > 0 (improvement), and cells shaded with | indicate A < 0 (no improvement).

| tesining

TIMO-Melbourne

TTIMO-Toronto

TTIMO-Florence

RAG Settings
Backbone | Somme | flnfeeneey | ABD REPLACE DELETE | ADD REPLACE DELETE | ADD REPLACE DELETE

Svea Sar Ovtca Sark Owed Sarm [Sued Sark Ovied Sarr Svea Sara |Onoa Gare Oued Sara Owoa Bare

Poshet 00% ase Shen SeGx Slax 210% SESH <ldx 700% S00n Sein 26m Q09n <IaSx Suen ason oan 92a

jn Shin “Ban aye Aix atm tase stim “isan son “e00n Oar 2eim 2n7e lx agen dan o49n 200m

Zecorshot| GPTiewtemdlarge 220 Dik 42x Ss0m ian -i00n 23m Wen SOR 200K aeax 0dn O17% rd asi Soon Stee Slam

Kalivcemmasideemd ata “aan 308 son Soe 270m 400% Wen 250m -200n Doon 203n ean “ISR aan aise tna 328m

Quenvabemd "aoe Den 509% S8an Sao “San Iban -A0Sn 000% I20n stam alan 012% isdn Seon Slam ao ie 00m

Gemmadth eve-ahot Mi0z 77% JAR Jaye STR san alSax IO3R «Soe i020 ARQ 14m s34n 95 <202R tax «isn «Tax

ota) int Side tan se “tee roe nox “Loon San te ean ioe “Iran “ex tom i207 sosen clon tree

ewshot | GeTicatemdlacge 222m WOR “Tan “IlOe Wlan 12TH .2hin iesm clign idm Toe ain 40x stim s260 sale sian toa

Kaliecemmasideemd Sem 1002 25m “laya “Ste 21m 23m sein 12628 Dee Oan 43m Jin Som s2van wale sien 170m

Qwenabemd "Sak 100% 00 Iran lvoe On 154% seSe sITSe w80e TR YR 20m tod deen saben 124m sae

int wax <ISax +008 36m J8qn <i00x 00% -ISem -IMIn IgQx s47Gx «220% 17 <10n araR wen -O5R 00%
ligament|S&Ticstemdlage tin fim “Gan San won “Tim sadn oan idk ede fom cove si0in aim tite teen oat aoe

ignment| cathcemmms-isbemd lan -ASk 8mm 17k Hae ign 29008 tea sllle sadn strom tMen stan s2]n silane singe “tee tae
Qwenvabemd six “Bem s00e s77e len olan s30n “aim 1222% titge :7han w280R silva ase cIS3R sI0me 6a 70R

Powshot “0x 0x 213% 200% 2am 24x 214m -leon 250% 216k Iam 7a lym -@an 201m teen —I5im 107m

int term bin 21x an aim “ain oan sox lox oraz Om Gon Gin dan “Osan Onym lian “lan

Zevoshot| GPTiewemdlarge sI35n si4an 213% Bate etm 70x Isan -03n Qoen Olen tien aan Sox Won 204m 267 Inge Ise

Kalivcemmasideemd 00" -23n 2038 “Inde Sven 253m OLIx 23 2am “iaon Jem fox 20a “Bln 26x 25m “1358 “10am

Gemmadth Qwenvabemd " s2u0n “70x 221% 20m ho -i0ee ISam ‘23m 309% 207m S0mm Inde sex 40m O7SH 20in lege 100%

(allen) Few-shot. 414.3% 4135% 214% 151% 414.3% 4135% 400% 444m 59% 5.9% 400% 44m 4100% 448% 100% 40.0% 40.0% 40.0%

jn HaGn 3se Glen ign “yin vain don iaex Son 2ox ‘Sam Gan “son tage due ign spon anon

Fewshst | GeTicatemdlarge  1200n 12438 “laa “I1GR tian sl0Gk 00K itiik So Sok Won ean sion osm oan inox aan aon

Kalivcemmatideemd 214m t24an 20m “I80n tiean clan De s1ldt igh “aah in ean si50% osm don nox adn noe

Qwenvabemd "sie 215% 214% 113% sle3% s108R 100n leak Som SOR 0On seek 1008 tate Mdm atm DOR ston

Powshot “Son 65m 0x Gen 2m 103% «Zien 40m 03K 220% em JOQR -le7H Sim JTS lien lax 20m

jn itn “jn ime Slam Hein ade Ss7m lege “20am “inde eae I3am “lave “Sox din win 2a an

Zewshot| GPTieemdlarge Sam aan T20R “Bex lage “J03R stile “Toe cIeix See 135% 55x Tan 12m “1052 “94m 2on 2e
Kalivcemmasideemd Isaz “81g 303 lean “Iga Im itim ston sgn inex “San -Gex J2sn “S0n “lese im 2m ame

Qwenvabemd " Mldx ceSk -eSx 20% 250 207% “dm ‘oan “ssn -20n lm Som “Sen 3m “105m Jam Sie ae

Lara 1-86 Powshet “25m «150% «65z 250e 00% +125x 400% 4002 -8m “lige WO" a9n 20K «2yem 00m 00x oon so0x

rota) int Bsn ison ism tiom Soe ox “iain noe laze ison “Sen non “bon i2oan toae tage aan sao

ewshot | GeTicatemdlacge I25e isdn s3m wIStm Sim ox On 00R doe won Sex Obe sox stain oon inex adn sao

Kaliecemmatideemd 125% 11508 sese sim Soe s00R DOR 00m tam 150% Sex s00R 20x s22an sdon nox waox sno

Qwenabemd "25 sI50n sham 1100E S0e DOR Ian MOR wim D0e Sex Ox 20m s204n de adn DOR ston

int A502 658 4196% 39% Blan IS4R GOGH a1lIn TH a67H GSR 40m 200% 30x 302 «20x Sn sLex

ligament|, S&Ticstemdlarge 2508 “ssn sau 200 Sm i3sq 700m tleye iret lem Oem 20m “i0en 25 ale Sgn ain tase

ignment| cathcemmms-istemd 50% “WOR s207R sham dem San 1200 Se sleek slim Woe Jon ciate 02m im ase Oa clan

Qwenvabcmd SOR “AYe hau 200 saox s5an 300K cloak “Tan vein ston MOR sO adn Glan sen an stan

Poycshot sox ox 21% 25n 7m LGR <lldx syax lex 99x sex «50x 102 99m 130m l02n Sim 2mm

tint Sits “Se Sit bon Ue SM ere 2a Ue ak Ee Stee oat ia 3

Zevoshot| GPTietemdlarge  J00e “3% SIX 25% Aim San Seu Wek 20m isan s4Sn sl0x 42x arm “i34n ide am 44
Kalivcemmasideemd “SOR “42% San Ade tlm 00e slitn sigmm ian “Sin 23x ston idan Tin “lee Idx 2m 2a

Hanes 3b Qwenabemd "008 “aon Sax “SON de “hae “Sem 105% Som 2m sliak six San 22m 1038 Jive TSR Soe

allot) Feve-shot 10% 4120% 420% 46am SOR 420% 71K wI5OR ADOR 487K See ADDR 01% 1K 400% OR wooK soo%

jn Nosm ute oon inon Que bon nim illex Sim 3dn Sax San iodn todn nue ane spon anon

ewshst | Gericatemdlacge isan <120n iS tm idan Sim won fim ison im see Sex Sam iin som soa iaox ax sao

Kaliwcemmatideemd 150m 11208 .2oe sean Sie 20% i7im siSon rm were See 00k six ioin idan inex gx sno

Qwenvabemd " S105% s120% 20 teak On 120m tin Ison Gym sere Sex MOR 0d todm Mdm adm DOR ston

Powshot 40% 428 eSn G6Ix 47x aG7R Goan Ig2m I01n lan 25% 00% 206m Ox 1x 95m J0n oe

jn Shon Zin nm Sen Gan sisen 250 “isan stdin saan 2a lox O3n “pen “iote lose Soe Sr

Zevoshot| GPTiewemdlarge “SOR “eon sidan on 70x wi33m let “WOSe won Tix aan 42m “lean gon idk I00n ton lore

Kaliwcemmasideemd 250% Jon san Laon 23m lin itm 33% i20en siege ion ican inae cee Ilse 2m ban “ISan

Qwenvabemd 508 -AGe ISR “83n sllex sien Term Ioan w295n vTde aan Qin “Gn asm "Orme Tim Tae “Te

Qwens-8b Powshet Woz s125R «43m QI sM3n «231m «143% MOOR «222% 183% 00H MOOK lay 400% 00K sO0n WOR s65n

Lot) int fox “eon idhen isoae stan saan tlean sean 202% ism won Mex “lax inde ae ade bon sean

ewshot | GeTicatemdlarge Oh 100% 190% sibam tian cIS4x s2hen 00R 339K sie Don iO0R “lan sO 0a inex dx ssi

Kalivcemmasideemd 50% “gin i038 aim tlean c28le sade 00 12008 Voan im 00R “Jan bm Oo tnox adn SI

Qwenvabemd O08 A2n 238R 2h s163% 123IK Clean seOR 1222% 183R DOR MOR lax sn Orn ae DOR sen

Bint HIIe «114% 722% s5G0n MOOR 49n 4528 MUOK «50% 42R 90K WIIAE 400% ISR WO9E 2m alan 42m

ligament|, S&Ticstemdlarge ude 0d" scil% sete adn 120% “JTm soon Soon dom sam silan .20SR San hye tage dan sal

ignment| cathGeras-isbemd <200% 00% selIn 400" wshlx w280n 25m shee w3Sin s20ME idm woIR sidan Gaye Den “DOR 23n slam

Qwenvabemd "MOR 123% 1SSeu soem sone 122m sO0" sleTe setTe s37Se wan 1136x267 tatR Det adm 328 123n

Powshet “an 20x «i99n 2an Sik J@n sis7 sean lm 50m -G0n Sou isSe 3m sax lim laze Joon

jn Ging ion sen bon Sex Son titdn tase in Soe pgm dan “isdn “ox am “aan yan aan

Zeoshot| GPTiewemdlarge “lage "20" 30% “age ioe dan Sen iin Gdn luge “Sim 35n “Iisn “ese idm lade -Ibee Tian
Kalicemmasideemd 46% 50m id eye 7m 30m 209% ssi Is2m “Tm 20 “Lax Son “ean “laGe “ex Dom Tom

Qwens-sb Qwenabemd "hae “S0n IMIR ale sade “hax Iidm ieee soe 25x aim clan Sax cere 1004 -lddn 205% -1aae

(eallet) Feve-shot 400% 20% 464% 448% 25K 18K 427% 45K 0G 425% 24K IR HIN Han 00R 400% wom so%

jn Bin in lnm bon Woon “lan ttm tase tem i2em don “lam gon isan toae inox aan ino

ewshst | Gericatemdlarge 25% “20 Mim iD <25n “Jan stim t0dk inte 25x stan tian isin won soon tage aan soon

Kalivcemmasideemd 00% “20m de “4an 25m an Addn “asm inde “25m an ilan agdx san soon nox aan cao

Qwenvabcmd "25m 20% sho 00k wdx “Sen W00n iaSe sem 25x WOR “lan 00h San Mdm stn D0 ston


===== page-12.png =====

Conference acronym "XX, June 03-05, 2018, Woodstock, NY Huang et al

(ADD operation)

You are an expert in Itinerary Perturbation
Your task must strictly follow these steps for the ADD operation

1, Definition of an itinerary
An itinerary is a sequence of visiting activities, where each activity is represented as
[POI name, POI category, longitude, latitude, popularity level]

2. Perturbation operation (ADD)

Insert exactly ONE new POL fron the candidate POIs into the original itinerary at any valid position
This addition must disrupt the itinerary in terms of at least one of the following aspects

= Spatial distance consistency

- Popularity consistency

- Category diversity consistency

3. Definitions of Consistency and Disruption
(2.1) Category Diversity (CD)
= Let k = number of distinct POI categories (case-insensitive), n = number of POIs

- Rule
If k then cD = @
Else, CD=k/n

= For ADD
categories_before = categories of the original itinerary
categories_after = categories_before plus the inserted POI's category
CD disruption occurs if and only if CD_before |= COafter

Debug outputs for CD (MUST include)
“categories_raw_before", "categories_set_before",
“categories_raw_after", "categories set_after",
“ed_before", “cd_after", "cd_disruption"

(2.2) Popularity Consistency
= Popularity levels: (High, Medium, Low)
- Let P = popularity level list before ADD, Q = after ADD.
= Compute

x Hellinger Distance (H) between normalized frequency distributions

* Kendall's Tau-b based on category counts -> assign ranks (higher count = smaller rank, ties share rank)
- Tau-b output rule

% Tf computed, output numeric value

% If skipped because H > @.1 already triggered disruption, output "skipped"
= Popularity disruption occurs if H > @.1 OR Tau-b <1

(2.3) Spatial Distance Consistency
= Distances computed between consecutive POIs using the Haversine formula

Haversine - Precision Rules (MUST follow)

= Use Haversine exactly: R = 6371.@ km; all trig in radians, rad = deg * pi/1ge.

= Compute dphi = phi2 - phit and dlambda = lanbda2 - lambdai in radians at FULL precision. No intermediate rounding or “approximation
= Half-angle only: a = sin*2(dphi/2) + cos(phit) * cos(phi2) * sin*Z(dlanbda/2) ;

¢ = 2 * atand(sqrt(a), sqrt(i-a)); d= R *c.

Do NOT drop the leading "2" in c; do NOT replace sin*2(d/2) with d*2. (Only if |d| < 1e-3 may you use (d/2)*2 as a small-angle
approximation.)

Round distances only at final display (<= 2 decimals). Segment classification must use the UNROUNDED d

- Classification
Low: < €}m, Medium: €}-£}m, High: > (2m,
Let P = Spatial category list before ADD, Q = after ADD
= Compute

x Hellinger Distance (H) between normalized frequency distributions

* Kendall's Tau-b based on category counts -> assign ranks (higher count = smaller rank, ties share rank)
= Tau-b output rule: same as Popularity.
= Spatial disruption occurs if H > @.1 OR Tau-b <1

Debug outputs for Spatial Distance (MUST include)
“spatial_distances_before", "spatial_categor ies_before",
“spatial_distances_after", "spatial_categories_after",
“spatial_H", "spatial_tau_b', "spatial_disruption"

4. Comparison and Intent Matching

Input includes a "Target Intent Count": 11213

- Always try to generate a perturbation that yields exactly this number of valid intents
- If it is possible, output that exact number

- If it is not possible, output the actual number of valid intents instead

= If no valid disruption exists, output "UNKNOWN"


===== page-13.png =====

iTIMO: An LLM-empowered Synthesis Dataset for Travel Itinerary Modification Conference acronym "XX, June 03-05, 2018, Woodstack, NY

1 (continued): System prompt of itinerary perturbation for DeepSeek (ADD operation)

INTENT SELECTION RULE (STRICT)

= If cddisruption = true -> include “Category diversity disruption"

= If popularity_disruption = true -> include "Popularity disruption"

- If spatial_disruption = true -> include "Spatial distance disruption"
= Intents mist equal exactly the set of all disruptions flagged true

= Only output "UNKNOWN" if ALL disruption flags are false

5. Final Verification
verify whether the perturbed itinerary satisfies the chosen intent (s)

Yalidate all numeric values

cd_before and cdLafter must be within [¢.@, 1.01

popularity. and spatial_H must be within [@.@, 1.1

popularity tau_b and spatial_tau_b must be within [-1.@, 1.0] if numeric.

If any value falls outside these ranges

Recompute CD, Hellinger distances, and Tau-b strictly following the rules in Section 3
Re-evaluate disruption flags and intents accordingly.

If after recomputation the values are still invalid, replace the entire result with "UNKNONN"

6. Output format
You MUST return the result in strict JSON format

“perturbed Itinerary": [...]
“Intents": C...1,

-- Category Debug --
“categories_raw_before": [...J,
“categories_set_before": [...]
“categories_rawafter": [...J,
"categories_set_after": [...],
“cd_before": <float>,
“cd_after": <float>,
“cd_disruption": true|false,

=~ Popularity Debug --
“popularity distribution_before": ("High":<int>, "Medium":<int>, "Low":<int>9,
“popularity_distribution_after": {"High":<int>, "Medium":<int>, "Low" :<int>),
“popular ity_ranks_before": {"High":<int>, "Medium" :<int>, "Low" :<int>},
“popularity_ranks_after": ("High":<int>, "Medium":<int>, "Low" :<int>},,
“popularity H": <Float>,

“popularity tau_b": <Float or "skipped">,

“popularity_disruption": true|false,

-- Spatial Debug -
“spatial_distances_before": [<float km,
"spatial_categor ies_before": ["Low"|"Medium"|"High", ...J,
“spatial_distances_after": [<float km>, ...],
"spatial_categor ies_after": ["Low"| "Medium" |"High
“spatial_H": <float>,

“spatial_tau_b": <float or "skipped">,
"spatial_disruption’: true/false

2


===== page-14.png =====

Conference acronym "XX, June 03-05, 2018, Woodstock, NY Huang et al

stem prompt of itinerary perturbation for DeepSeek V: operation)

You are an expert in Itinerary Perturbation
Your task must strictly follow these steps for the DELETE operation

1, Definition of an itinerary
An itinerary is a sequence of visiting activities, where each activity is represented as
[POI name, POI category, longitude, latitude, popularity level]

2. Perturbation operation (DELETE)

Remove exactly ONE POI from the original itinerary

This deletion must disrupt the itinerary in terms of at least one of the following aspects
= Spatial distance consistency

- Popularity consistency

- Category diversity consistency

3. Definitions of Consistency and Disruption
(2.1) Category Diversity (CD)
= Let k = number of distinct POI categories (case-insensitive), n = number of POIs
- Rule

If k then CD = @

Else, CD=k/n

For DELETE
categories_before = categories of the original itinerary
categories_after = categories_before minus the deleted POI's category (if no other POI of that category remains)
CD disruption occurs if and only if CD_before != CO_after

Debug outputs for CD (MUST include)
“categories_raw_before", "categories_set_before",
“categories_raw_after", "categories set_after",
“ed_before", “cd_after", "cd_disruption"

(2.2) Popularity Consistency
= Popularity levels: (High, Medium, Low)
- Let P = popularity level list before DELETE, Q = after DELETE
= Compute

x Hellinger Distance (H) between normalized frequency distributions

* Kendall's Tau-b based on category counts -> assign ranks (higher count = smaller rank, ties share rank)
- Tau-b output rule

* Tf computed, output numeric value

* If skipped because H > @.1 already triggered disruption, output "skipped"
= Popularity disruption occurs if H > @.1 OR Tau-b <1

(2.3) Spatial Distance Consistency
= Distances computed between consecutive POIs using the Haversine formula
~ Classification
Low: < €}m, Medium: €}-£}m, High: > (3m.
- Let P = spatial category list before DELETE, Q = after DELETE
= Compute
x Hellinger Distance (H) between normalized frequency distributions
* Kendall's Tau-b based on category counts -> assign ranks (higher count = smaller rank, ties share rank)
= Tau-b output rule: same as Popularity.
Spatial disruption occurs if H > @.1 OR Tau-b <1

Debug outputs for Spatial Distance (MUST include)
“spatial_distances_before", "spatial_categor ies_before",
“spatial_distances_after", "spatial_categories_after",
“spatial_H", "spatial_tau_b', "spatial_disruption"

4. Comparison and Intent Matching

Compare the original and perturbed itineraries

From the candidate intents, select only those that are truly supported by the above rules
Tf none apply, output UNKNOWN”

INTENT SELECTION RULE (STRICT)

= If cddisruption = true -> include “Category diversity disruption"

= If popularity_disruption = true -> include "Popularity disruption"

= If spatial_disruption = true -> include "Spatial distance disruption"
= Intents mist equal exactly the set of all disruptions flagged true

= Only output "UNKNOWN" if ALL disruption flags are false

5. Final Verification
verify whether the perturbed itinerary satisfies the chosen intent (s)
Validate all numeric values


===== page-15.png =====

iTIMO: An LLM-empowered Synthesis Dataset for Travel Itinerary Modification Conference acronym "XX, June 03-05, 2018, Woodstack, NY

(continued): System prompt of itinerary perturbation for DeepSeek V3.2 and operation)

cd_before and ccLafter must be within [¢.@, 1.1
popularity. and spatial_H must be within [@.@, 1.1

popularity tau_b and spatial_tau_b must be within [-1.@, 1.0] if numeric.

If any value falls outside these ranges

Recompute CD, Hellinger distances, and Tau-b strictly following the rules in Section 3
Re-evaluate disruption flags and intents accordingly.

If after recomputation the values are still invalid, replace the entire result with "UNKNOWN"

6. Output format
You MUST return the result in strict JSON format
t

“perturbed Itinerary": [...]

“Intents": C...1,

-- Category Debug --
“categories_raw_before": [...J,
“categories_set_before": [...]
“categories_raw_after": [...J,
“categories_set_after": [...J,
“cd_before": <float>,
“cdLafter": <float>,
“cd_disruption": true|false,

== Popularity Debug --
“popularity _distribution_before": ("High":<int>, "Medium":<int>, "Low":<int>9,
“popularity _distribution_after": {"High":<int>, "Medium":<int>, "Low" :<int>),
“popularity_ranks_before": {"High":<int>, "Medium' :<int>, "Low" :<int>},
“popularity_ranks_after": ("High":<int>, "Medium" :<int>, "Low" :<int>},
“popularity H": <Float>,

“popularity_tau_b": <Float or "skipped">,

“popularity_disruption": true|false,

-- Spatial Debug --
“spatial_distances_before": [<float km,
"spatial_categor ies_before": ["Low"|"Medium"|"High", ...J,
"spatial_distances_after": [<float km>,
"spatial_categories_after": ["Low"|"Medium"|"High", ...]
“spatial _H": <float>,

“spatial_tau_b": <float or "skipped">,
"spatial_disruption’: true/false

2


===== page-16.png =====

Conference acronym "XX, June 03-05, 2018, Woodstock, NY Huang et al

stem prompt of itinerary perturbation for DeepSeek V: E operation)

You are an expert in Itinerary Perturbation
Your task must strictly follow these steps for the REPLACE operation

1, Definition of an itinerary
An itinerary is a sequence of visiting activities, where each activity is represented as
[POI name, POI category, longitude, latitude, popularity level]

2. Perturbation operation (REPLACE)

Replace exactly ONE POL in the original itinerary with ONE new POL from the candidate POIs
This replacement must disrupt the itinerary in terms of at least one of the following aspects
= Spatial distance consistency

- Popularity consistency

- Category diversity consistency

3. Definitions of Consistency and Disruption
(2.1) Category Diversity (CD)
= Let k = number of distinct POI categories (case-insensitive), n = number of POIs
- Rule

If k then CD = @

Else, CD=k/n
= For REPLACE

categories_before = categories of the original itinerary

categories_after = categories_before but with replaced POI's category substituted
= Sets and ratios

Cb_before = |set(categories before)| / len(or iginal_itinerary)

Co_after = |set(categories_after)| / len (perturbed_itinerary)

CD disruption occurs if:

* The CD ratio changes

Debug outputs for CD (MUST include)
“categories_raw_before", "categories_set_before",
“categories_raw_after", "categories set_after",
“ed_before", “cd_after", "cd_disruption"

(2.2) Popularity Consistency
= Popularity levels: (High, Medium, Low)
- Let P = popularity level list before REPLACE, Q = after REPLACE
= Compute

x Hellinger Distance (H) between normalized frequency distributions

* Kendall's Tau-b based on category counts -> assign ranks (higher count = smaller rank, ties share rank)
- Tau-b output rule

* Tf computed, output numeric value

* If skipped because H > @.1 already triggered disruption, output "skipped"
= Popularity disruption occurs if H > @.1 OR Tau-b <1

(2.3) Spatial Distance Consistency
= Distances computed between consecutive POIs using the Haversine formula
- Classification
Low: < €}m, Medium: €}-£}m, High: > (Mm,
- Let P = spatial category list before REPLACE, Q = after REPLACE
= Compute
x Hellinger Distance (H) between normalized frequency distributions
* Kendall's Tau-b based on category counts -> assign ranks (higher count = smaller rank, ties share rank)
= Tau-b output rule: same as Popularity.
Spatial disruption occurs if H > @.1 OR Tau-b <1

Debug outputs for Spatial Distance (MUST include)
“spatial_distances_before", "spatial_categor ies_before",
“spatial_distances_after", "spatial_categories_after",
“spatial_H", "spatial_tau_b', "spatial_disruption"

4. Comparison and Intent Matching

Input includes a "Target Intent Count": 11213

- Always try to generate a perturbation that yields exactly this number of valid intents
- If it is possible, output that exact number

- If it is not possible, output the actual number of valid intents instead

= If no valid disruption exists, output "UNKNOWN"

INTENT SELECTION RULE (STRICT)

= If cddisruption = true -> include “Category diversity disruption"

= If popularity_disruption = true -> include "Popularity disruption"

= If spatial_disruption = true -> include "Spatial distance disruption"
= Intents mist equal exactly the set of all disruptions flagged true


===== page-17.png =====

iTIMO: An LLM-empowered Synthesis Dataset for Travel Itinerary Modification Conference acronym "XX, June 03-05, 2018, Woodstack, NY

continued): System prompt of itinerary perturbation for DeepSeek V2 operation’
promp P P 1

= Only output "UNKNOWN" if ALL disruption flags are false

5. Final Verification
verify whether the perturbed itinerary satisfies the chosen intent (s)

Yalidate all numeric values

cd_before and cdLafter must be within [¢.@, 1.01

popularity. and spatial_H must be within [@.@, 1.1

popularity tau_b and spatial_tau_b must be within [-1.@, 1.0] if numeric.

If any value falls outside these ranges

Recompute CD, Hellinger distances, and Tau-b strictly following the rules in Section 3
Re-evaluate disruption flags and intents accordingly.

If after recomputation the values are still invalid, replace the entire result with "UNKNOWN"

6. Output format
You MUST return the result in strict JSON format

“perturbed Itinerary": [...]
“Intents": C...1,

-- Category Debug --
“categories_raw_before": [...J,
“categories_set_before": [...]
“categories_raw_after": [...J,
“categories_set_after": [...J,
“cd_before": <float>,
“cdLafter": <float>,
“cd_disruption": true|false,

== Popularity Debug --
“popularity _distribution_before": ("High":<int>, "Medium":<int>, "Low":<int>9,
“popularity _distribution_after": {"High":<int>, "Medium":<int>, "Low" :<int>),
“popularity_ranks_before": {"High":<int>, "Medium' :<int>, "Low" :<int>},
“popularity_ranks_after": ("High":<int>, "Medium" :<int>, "Low" :<int>},
“popularity H": <Float>,

“popularity_tau_b": <Float or "skipped">,

“popularity_disruption": true|false,

-- Spatial Debug --
“spatial_distances_before": [<float km,
"spatial_categor ies_before": ["Low"|"Medium"|"High", ...J,
"spatial_distances_after": [<float km>,
"spatial_categories_after": ["Low"|"Medium"|"High", ...]
“spatial _H": <float>,

“spatial_tau_b": <float or "skipped">,
"spatial_disruption*: true/false

2


===== page-18.png =====

Conference acronym "XX, June 03-05, 2018, Woodstock, NY Huang et al

stem prompt of itinerary perturbation for our V: DD operation)

You are an expert in Itinerary Perturbation
Your task must strictly follow these steps for the ADD operation

HARD OUTPUT CONTRACT (ABSOLUTE)
= SILENT MODE: Output ONLY ONE final JSON object wrapped EXACTLY as
<final_json>{ ...STRICT JSON OBJECT... }</Final_json>
% The FIRST non-whitespace characters MUST be "<Final_json>"
% The LAST characters MUST be "</final_json>"
¥ NO preamble text, NO trailing text, NO code fences
- If you cannot complete valid metrics after retries, emit
<final_json>("error":"no_final_json"}</final_json>
= All non-final notes go in <think>. ..</think> ONLY (brief prose). If tokens are low, SKIP <think>

@) Tool-Calling Contract (HARD RULES - zero-onission)

= Zero omission: supply ALL required keys exactly; no renaming; no missing args

= Retry on error: on {"error":...} you MUST re-call the SAME tool with corrected args until success or fallback.

- Case discipline / domains

* Popularity labels MUST be Title Case "High", "Medium", "Low" (domain=["High" "Medium", "Low"])

& Spatial classes MUST be Title Case "Low", "Medium", "High" (domain=f"Low" "Medium", "High"])

ADD length invariant: len(Perturbed Itinerary) == len(Original Itinerary) + 1

= COPY-THROUGH LOCK (global): Any metric/array/dict returned by a tool is the SINGLE SOURCE OF TRUTH

You MUST mirror tool values verbatim into the final TSON fields that bear the same meaning. NEVER fabricate or recale.
GEO lock: Call geo_distance_segments EXACTLY ONCE with BOTH waypoint lists. Reuse that first valid result throughout

5) MEMORY (optional but binding if present)

Input may include {"Memory": ...}. Obey your rules for diversity priority.

- Diversity rule for abd

1) Prefer inserting a POI whose name is NOT in used_poi (exact string match)

2) Prefer an insertion index i NOT in used_index; if unavoidable, choose among the least-used indices

3) If multiple valid insertions meet the Target Intent Count, select one differing from Memory in BOTH POI and index; if still tied,
sample uniformly at random

4) Do NOT change output schema. any justification stays in <think> only (brief prose)

1) Itinerary Definition
Each activity: [POL name, POI category, longitude, latitude, popularity level]

2) ADD Operation
Insert EXACTLY ONE candidate POI at index i (@..n, with n=len(Original Itinerary)). All other entries remain unchanged and order
preserved
The insertion must disrupt at least one of
- Spatial distance consistency
- Popularity consistency
= Category diversity consistency
Build order
1) Decide the insertion index i and construct the full Perturbed Itinerary FIRST
2) Then call geo_distance_segments EXACTLY ONCE with BOTH lists (use numeric floats for lat/lon). Reuse that FIRST valid result

3) Consistency Definitions & Echo Contracts

(2.1) Category Diversity (CD) - TOOL-ECHO
= Get categories via TWO calls to categories_from itinerary
cats_before := categories fromitinerary({"itiner ary": Original Itinerary}). categories
cats_after := categories_from_itinerary({"itiner ary": Perturbed Itinerary?) .categor ies
- HARD SOURCE: “categories rawbefore/after" MUST be EXACT copies of these arrays (token-by-token, including case/punct)
categories_set_* = unique of categories raw_* (preserve tokens, order not enforced)
Echo Gate (must hold BEFORE cd_fromcategories and BEFORE <final_json>)
* Len(categories_rawbefore) == len(Original Itinerary)
* Len(categories_raw_after) == len(Perturbed Itinerary)
* for all i: categories rawbefore[i] == Original ItineraryfiJ[11
* for all i: categories rawafter[i] == Perturbed ItineraryCi][1]

- Call cd_fromcategories ONLY with those echoed arrays; MIRROR its returns directly into
“categories_raw_before
“categories_raw_after™

categories_set_before"
“categories_set_after",
s"cd_disrupt ion"

(2.2) Popularity Consistency - TOOL-ECHO & CANON
= Fer-item echo from itinerary col #5 (NO synthesis)
pop_raw_before := [ Original ItineraryCjJ[4] for j 1
pop_raw_after = [ Perturbed ItineraryC{1[4] for j 1
= Canonicalize by mapping ("high": "High", "medium": "Medium", "Low": "Low"} ONLY.
after canon, EVERY label MUST be in {"High","Medium", "Low"?
= Echo Gate (must hold BEFORE stats_from_categor ies (popular ity))


===== page-19.png =====

iTIMO: An LLM-empowered Synthesis Dataset for Travel Itinerary Modification Conference acronym "XX, June 03-05, 2018, Woodstack, NY

(continued): System prompt of itinerary perturbation for our V3.2 FM (ADD operation)

Len(pop_raw_before) == len(Original Itinerary)

len(pop_rawafter) == len(Perturbed Itinerary)

for all J: pop_rawbeforeLj] equals Original Itinerary[j][4] up to case normalization ONLY

for all j: pop_rawafter[j] equals Perturbed Itinerary(j][4] up to case normalization ONLY

= anti-cheat (fatal): labels_* MUST NOT be (a permutation of) the domain UNLESS it exactly matches the itinerary echo

Call stats_from_categories with the CANON arrays and domain=["High", "Medium" ,"Low"], thresholds=("hellinger":@.1,"tau_b":1.@)

= MIRROR its returns directly into:
“popular ity_distribution_before" ,"popularity_distribution_after",
“popularity_ranks_before" , "popular ity_ranks_after",
“popular ity_H", "popularity_tau_b" , "popular ity_disruption"

(2.3) Spatial Distance Consistency - TOOL-ECHO & LOCK
= Build waypoints_before/after fron itinerary cols (lat,lon) as floats. Call geo distance_segments ONCE
- Segment alignment with n=len(Original Itinerary) MUST hold

len (spatial_distances_before) == max(@, n-1)

len(spatial_distances_after) == max(@, n)

and len (spatial_categories_*) equals the corresponding distances length
- Then call stats_fromcategories on spatial classes with donain=["Low","Medium","High"], thresholds=("hellinger":0.1,"tau_b":1. 0}
MIRROR BOTH tool returns directly into ALL spatial debug fields
“spatial_distances_before" ,"spatial_categories_before" ,"spatial_ranks_before",
“spatial _distances_after", "spatial_categor ies_after", "spatial_ranks_after",
“spatial_H" ,"spatial_tau_b" ,"spatial_disruption"

MIRROR & ASSERT (HARD KILL-SWITCH)
- after all tools succeed and BEFORE emitting <final_json>, you MUST perform these checks
1) Equality mirror: For each of the 3 pillars (CO/Popular ity/Spatial),
= The boolean “* disruption” in your JSON MUST equal the tool field exactly.
= Each numeric/debug field you output MUST equal the corresponding tool field (same numbers up to normal float formatting)
If ANY mismatch -> RECONSTRUCT the JSON by directly copying the tool dictionaries into the JSON fields (no free-typing)
If still mismatched -> emit <final_json>{"error":"no_final_json"}</final_json>
2) Ranges: @cscd_kc=t, @c=kHe=1, -1<=k_tau_b<=1 (numeric). If violated, re-call tool or emit error JSON
3) Echo Gates re-check for categories & popularity (lengths and per-item equality to itineraries). If violated, fix and re-call tools

A) Atomic Intents Builder (MUST OVERWRITE)
~ set
cd_flag = cd_from_categories.cd_disruption
pop_flag := stats_from_categor ies(popularity) .disruption
spa_flag := stats_from_categor ies(spatial) disruption
~ Deterministic order ing
1) “Category diversity disruption" if cd_flag
2) “Popularity disruption" if pop_flag
3) "Spatial distance disruption" if spa_flag
Overwrite TSON["Intents"] with exactly these (or ["UNKNONN"] if none true). No trimming to match target counts

4) Target Intent Count (planning only)
= Input "Target Intent Count" is ONLY for choosing index/POL; NEVER appears in output

5) Final JSON Hygiene
- only double-quoted strings; no trailing commas; no NaN/Inf; booleans are true/false
= Keys required (exact names)
£

Ferturbed Itinerary": [...1

“Intents": [...1,

“categories_raw_before": [...J,
“categories_set_before": [...]
“categories_raw_after": [...J,
“categories_set_after": [...J,
“cd_before": <float>,
“cd_after": <float>,
“cd_disruption": true|false,

“popularity distribution_before": { "High": <Float>, "Medium": <Float>, "Low": <float> 3,
“popularity_distribution_after": { "High": <Float>, "Medium": <Float>, "Low": <float> },
“popularity_ranks_before": { ... 7,

“popularity_ranks_after": £7,

“popularity H": <Float>,

“popularity_tau_b": <Float>,

“popular ity_disruption": true|false,

"spatial_distances_before": [...]
"spatial_categories_before": [...1,
“spatial_ranks before": { ... }


===== page-20.png =====

Conference acronym "XX, June 03-05, 2018, Woodstock, NY Huang et al

Box 4 (continued): System prompt of itinerary perturbation for our V3.2 FM (ADD operation)

"spatial_distances_after"
"spatial_categor ies_after"
“spatial_ranks_after": {
“spatial_H": <float>,
“spatial_tau_b": <float>,
"spatial_disruption’: true/false
2

Output discipline
= Do NOT compute metrics in text; use tools only and MIRROR

- Inmediately before </final_json>, run MIRROR & ASSERT and the Atomic Intents Builder (overwrite JSON["Intents"])

- If any assertion fails and cannot be corrected by tool re-calls, output <final_json>{"error":"no_final_json"}</final_json>


===== page-21.png =====

iTIMO: An LLM-empowered Synthesis Dataset for Travel Itinerary Modification Conference acronym "XX, June 03-05, 2018, Woodstack, NY

operation)

You are an expert in Itinerary Perturbation
Your task must strictly follow these steps for the DELETE operation

HARD OUTPUT CONTRACT (ABSOLUTE)
= SILENT MODE: Output ONLY ONE final JSON object wrapped EXACTLY as
<final_json>{ ...STRICT JSON OBJECT... }</Final_json>
% The FIRST non-whitespace characters MUST be "<Final_json>"
% The LAST characters MUST be "</final_json>"
¥ NO preamble text, NO trailing text, NO code fences
- If you cannot complete valid metrics after retries, emit
<final_json>("error":"no_final_json"}</final_json>
= All non-final notes go in <think>. ..</think> ONLY (brief prose). If tokens are low, SKIP <think>

@) Tool-Calling Contract (HARD RULES - zero-onission)

= Zero omission: supply ALL required keys exactly; no renaming; no missing args

= Retry on error: on {"error":...} you MUST re-call the SAME tool with corrected args until success or fallback.

- Case discipline / domains

* Popularity labels MUST be Title Case "High", "Medium", "Low" (domain=["High" "Medium", "Low"])

& Spatial classes MUST be Title Case "Low", "Medium", "High" (domain={"Low" "Medium", "High"])

DELETE length invariant: len(Perturbed Itinerary) == len(Original Itinerary) - 1

= COPY-THROUGH LOCK (global): Any metric/array/dict returned by a tool is the SINGLE SOURCE OF TRUTH

You MUST mirror tool values verbatim into the final TSON fields that bear the same meaning. NEVER fabricate or recale.
GEO lock: Call geo_distance_segments EXACTLY ONCE with BOTH waypoint lists. Reuse that first valid result throughout

5) MEMORY (optional but binding if present)

Input may include {"Memory": ...}. Obey your rules for diversity priority.

- Diversity rule for DELETE

1) Prefer deleting a POI whose name is NOT in used_poi (exact string match)

2) Prefer a delete index i NOT in used_index; if unavoidable, choose among the least-used indices

3) If multiple valid deletions meet the Target Intent Count, select one differing from Memory in BOTH POI and index; if still tied,
sample uniformly at random

4) Do NOT change output schema. any justification stays in <think> only (brief prose)

1) Itinerary Definition
Each activity: [POL name, POI category, longitude, latitude, popularity level]

2) DELETE Operation
Delete EXACTLY ONE existing POI at index i (@..n-1, with
preserved
The deletion must disrupt at least one of
- Spatial distance consistency
- Popularity consistency
= Category diversity consistency
Build order
1) Decide the deletion index i and construct the full Perturbed Itinerary FIRST.
2) Then call geo_distance_segments EXACTLY ONCE with BOTH lists (use numeric floats for lat/lon). Reuse that FIRST valid result

=len(Original Itinerary)). All other entries remain unchanged and order

3) Consistency Definitions & Echo Contracts

(2.1) Category Diversity (CD) - TOOL-ECHO
= Get categories via TWO calls to categories_from itinerary
cats_before := categories fromitinerary({"itiner ary": Original Itinerary}). categories
cats_after := categories_from_itinerary({"itiner ary": Perturbed Itinerary?) .categor ies
- HARD SOURCE: “categories rawbefore/after" MUST be EXACT copies of these arrays (token-by-token, including case/punct)
categories_set_* = unique of categories raw_* (preserve tokens, order not enforced)
Echo Gate (must hold BEFORE cd_fromcategories and BEFORE <final_json>)
* Len(categories_rawbefore) == len(Original Itinerary)
* Len(categories_raw_after) == len(Perturbed Itinerary)
* for all i: categories rawbefore[i] == Original ItineraryfiJ[11
* for all i: categories rawafter[i] == Perturbed ItineraryCi][1]

- Call cd_fromcategories ONLY with those echoed arrays; MIRROR its returns directly into
“categories_raw_before
“categories_raw_after™

categories_set_before"
“categories_set_after",
s"cd_disrupt ion"

(2.2) Popularity Consistency - TOOL-ECHO & CANON
= Fer-item echo from itinerary col #5 (NO synthesis)
pop_raw_before := [ Original ItineraryCjJ[4] for j 1
pop_raw_after = [ Perturbed ItineraryC{1[4] for j 1
= Canonicalize by mapping ("high": "High", "medium": "Medium", "Low": "Low"} ONLY.
after canon, EVERY label MUST be in {"High","Medium", "Low"?
= Echo Gate (must hold BEFORE stats_from_categor ies (popular ity))


===== page-22.png =====

Conference acronym "XX, June 03-05, 2018, Woodstock, NY Huang et al

5 (continued): System prompt of itinerary perturbation for our operation)

Len(pop_raw_before) == len(Original Itinerary)
len(pop_rawafter) == len(Perturbed Itinerary)
for all J: pop_rawbeforeLj] equals Original Itinerary[j][4] up to case normalization ONLY
for all j: pop_rawafter[j] equals Perturbed Itinerary(j][4] up to case normalization ONLY
= anti-cheat (fatal): labels_* MUST NOT be (a permutation of) the domain UNLESS it exactly matches the itinerary echo
Call stats_from_categories with the CANON arrays and domain=["High", "Medium" ,"Low"], thresholds=("hellinger":@.1,"tau_b":1.@)
= MIRROR its returns directly into:
“popular ity_distribution_before" ,"popularity_distribution_after",
“popularity_ranks_before" , "popular ity_ranks_after",
“popular ity_H", "popularity_tau_b" , "popular ity_disruption"

(2.3) Spatial Distance Consistency - TOOL-ECHO & LOCK
= Build waypoints_before/after fron itinerary cols (lat,lon) as floats. Call geo distance_segments ONCE
- Segment alignment with n=len(Original Itinerary) MUST hold

len (spatial_distances_before) == max(@, n-1)

len(spatial_distances_after) == max(@, (n-1)-1)# i.e, max(@, n-2)

and len (spatial_categories_*) equals the corresponding distances length
- Then call stats_fromcategories on spatial classes with donain=["Low","Medium","High"], thresholds=("hellinger":0.1,"tau_b":1. 0}
MIRROR BOTH tool returns directly into ALL spatial debug fields
“spatial_distances_before" ,"spatial_categories_before" ,"spatial_ranks_before",
“spatial _distances_after", "spatial_categor ies_after", "spatial_ranks_after",
“spatial_H" ,"spatial_tau_b" ,"spatial_disruption"

MIRROR & ASSERT (HARD KILL-SWITCH)
- after all tools succeed and BEFORE emitting <final_json>, you MUST perform these checks
1) Equality mirror: For each of the 3 pillars (CO/Popular ity/Spatial),
= The boolean “* disruption” in your JSON MUST equal the tool field exactly.
= Each numeric/debug field you output MUST equal the corresponding tool field (same numbers up to normal float formatting)
If ANY mismatch -> RECONSTRUCT the JSON by directly copying the tool dictionaries into the JSON fields (no free-typing)
If still mismatched -> emit <final_json>{"error":"no_final_json"}</final_json>
2) Ranges: @cscd_kc=t, @c=kHe=1, -1<=k_tau_b<=1 (numeric). If violated, re-call tool or emit error JSON
3) Echo Gates re-check for categories & popularity (lengths and per-item equality to itineraries). If violated, fix and re-call tools

A) Atomic Intents Builder (MUST OVERWRITE)
~ set
cd_flag = cd_from_categories.cd_disruption
pop_flag := stats_from_categor ies(popularity) .disruption
spa_flag := stats_from_categor ies(spatial) disruption
~ Deterministic order ing
1) “Category diversity disruption" if cd_flag
2) “Popularity disruption" if pop_flag
3) "Spatial distance disruption" if spa_flag
Overwrite TSON["Intents"] with exactly these (or ["UNKNONN"] if none true). No trimming to match target counts

4) Target Intent Count (planning only)
= Input "Target Intent Count": 112|3. It is ONLY a planning constraint to help you choose index/POL; NEVER appear in output

5) Final JSON Hygiene
- only double-quoted strings; no trailing commas; no NaN/Inf; booleans are true/false
= Keys required (exact names)
£

Ferturbed Itinerary": [...1

“Intents": [...1,

“categories_raw_before": [...J,
“categories_set_before": [...]
“categories_raw_after": [...J,
“categories_set_after": [...J,
“cd_before": <float>,
“cd_after": <float>,
“cd_disruption": true|false,

“popularity distribution_before": { "High": <Float>, "Medium": <Float>, "Low": <float> 3,
“popularity_distribution_after": { "High": <Float>, "Medium": <Float>, "Low": <float> },
“popularity_ranks_before": { ... 7,

“popularity_ranks_after": £7,

“popularity H": <Float>,

“popularity_tau_b": <Float>,

“popular ity_disruption": true|false,

"spatial_distances_before": [...]
"spatial_categories_before": [...1,
“spatial_ranks before": { ... }


===== page-23.png =====

iTIMO: An LLM-empowered Synthesis Dataset for Travel Itinerary Modification Conference acronym "XX, June 03-05, 2018, Woodstack, NY

Box 5 (continued): System prompt of itinerary perturbation for our V3.2 FM (DELETE operation)

"spatial_distances_after"
"spatial_categor ies_after"
“spatial_ranks_after": {
“spatial_H": <float>,
“spatial_tau_b": <float>,
"spatial_disruption’: true/false
2

Output discipline
= Do NOT compute metrics in text; use tools only and MIRROR

- Inmediately before </final_json>, run MIRROR & ASSERT and the Atomic Intents Builder (overwrite JSON["Intents"])

- If any assertion fails and cannot be corrected by tool re-calls, output <final_json>{"error":"no_final_json"}</final_json>


===== page-24.png =====

Conference acronym "XX, June 03-05, 2018, Woodstock, NY Huang et al

operation)

You are an expert in Itinerary Perturbation
Your task must strictly follow these steps for the REPLACE operation

HARD OUTPUT CONTRACT (ABSOLUTE)
= SILENT MODE: Output ONLY ONE final JSON object wrapped EXACTLY as
<final_json>{ ...STRICT JSON OBJECT... }</Final_json>
% The FIRST non-whitespace characters MUST be "<Final_json>"
% The LAST characters MUST be "</final_json>"
¥ NO preamble text, NO trailing text, NO code fences
- If you cannot complete valid metrics after retries, emit
<final_json>("error":"no_final_json"}</final_json>
= All non-final notes go in <think>. ..</think> ONLY (brief prose). If tokens are low, SKIP <think>

@) Tool-Calling Contract (HARD RULES - zero-onission)

= Zero omission: supply ALL required keys exactly; no renaming; no missing args

= Retry on error: on {"error":...} you MUST re-call the SAME tool with corrected args until success or fallback.

- Case discipline / domains

* Popularity labels MUST be Title Case "High", "Medium", "Low" (domain=["High" "Medium", "Low"])

% Spatial classes MUST be Title Case "Low", "Medium", "High" (domain={"Low" "Medium", "High"])

REPLACE length invariant: len(Perturbed Itinerary) == len (Original Itinerary)

= COPY-THROUGH LOCK (global): any metric/array/dict returned by a tool is the SINGLE SOURCE OF TRUTH

You MUST mirror tool values verbatim into the final JSON fields that bear the same meaning. NEVER fabricate or recale.

Call order & locking (REPLACE)

1) Decide the exact index i and construct the full Perturbed Itinerary FIRST (replace exactly one POI at index i with one candidate; all
other entries unchanged in name/category/coordinates/popularity and order)

2) Then call geo_distance_segments EXACTLY ONCE with BOTH lists (use numeric floats for Lat/Lon). Reuse that FIRST valid result; do NOT
call again or overwrite distances/classes

5) MEMORY (optional but binding if present)

= Input may include {"Memory": ...}. Obey your rules for diversity priority.

- Diversity rule for REPLACE

1) Prefer choosing a REPLACE index i NOT in used_index; if unavoidable, choose among the least-used indices

2) Prefer selecting a NEW candidate POI whose name is NOT in used_poi (exact string match); if unavoidable, choose among the least-used
names

3) If multiple valid replacements meet the Target Intent Count, select one differing from Memory in BOTH the target index and the new
Por; if still tied, sample uniformly at random.

4) Do NOT change output schema. any justification stays in <think> only (brief prose)

1) Itinerary Definition
Each activity: [POL name, POI category, longitude, latitude, popularity level]

2) REPLACE Operation
Replace EXACTLY ONE existing POI with EXACTLY ONE candidate at the SAME index i. Disrupt at least one of:
= Spatial distance consistency

- Popularity consistency

- Category diversity consistency

3) Consistency Definitions & Echo Contracts

(2.1) Category Diversity (CD) - TOOL-ECHO
= Get categories via TWO calls to categories_from itinerary
cats_before := categories fromitinerary({"itiner ary": Original Itinerary}). categories
cats_after := categories_from_itinerary({"itiner ary": Perturbed Itinerary?) .categor ies
- HARD SOURCE: “categories rawbefore/after" MUST be EXACT copies of these arrays (token-by-token, including case/punct)
categories_set_* = unique of categories raw_* (preserve tokens, order not enforced)
Echo Gate (must hold BEFORE cd_fromcategories and BEFORE <final_json>)
* Len(categories_rawbefore) == len(Original Itinerary)
* Len(categories_raw_after) == len(Perturbed Itinerary)
* for all i: categories rawbefore[i] == Original ItineraryfiJ[11
* for all i: categories rawafter[i] == Perturbed ItineraryCi][1]

- Call cd_fromcategories ONLY with those echoed arrays; MIRROR its returns directly into
“categor ies_raw_before"

categories_set_before",
categories_set_after",
“ed_disruption"

(2.2) Popularity Consistency - TOOL-ECHO & CANON
= Per-item echo from itinerary col #5 (NO synthesis)
pop_raw_before := [ Original ItineraryCjJ[4] for j 1
pop_raw_after = [ Perturbed ItineraryC{1[4] for j 1
= Canonicalize by mapping ("high": "High", "medium": "Medium", "Low": "Low"} ONLY.
after canon, EVERY label MUST be in {"High","Medium","Low"}
= Echo Gate (must hold BEFORE stats_from_categories (popular ity))


===== page-25.png =====

iTIMO: An LLM-empowered Synthesis Dataset for Travel Itinerary Modification Conference acronym "XX, June 03-05, 2018, Woodstack, NY

6 (continued): System prompt of itinerary perturbation for our E operation)

Len(pop_raw_before) == len(Original Itinerary)
len(pop_rawafter) == len(Perturbed Itinerary)
for all J: pop_rawbeforeLj] equals Original Itinerary[j][4] up to case normalization ONLY
for all j: pop_rawafter[j] equals Perturbed Itinerary(j][4] up to case normalization ONLY
= anti-cheat (fatal): labels_* MUST NOT be (a permutation of) the domain UNLESS it exactly matches the itinerary echo
Call stats_from_categories with the CANON arrays and domain=["High", "Medium" ,"Low"], thresholds=("hellinger":@.1,"tau_b":1.@)
= MIRROR its returns directly into:
“popular ity_distribution_before" ,"popularity_distribution_after",
“popularity_ranks_before" , "popular ity_ranks_after",
“popular ity_H", "popularity_tau_b" , "popular ity_disruption"

(2.3) Spatial Distance Consistency - TOOL-ECHO & LOCK
= Build waypoints_before/after fron itinerary cols (lat,lon) as floats. Call geo distance_segments ONCE
- Segment alignment with n=len(Original Itinerary) MUST hold
len(spatial_distances_before) == len(spatial_distances_after) == max(@, n-1),
and len (spatial_categories_*) equals the corresponding distances length
- Then call stats_fromcategories on spatial classes with domain=["Low" "Medium",
= SPATIAL MIRROR CONTRACT (REPLACE)
* "spatial_distances_before" := geo result.distances_before
& "spatial_categories_before" := geo_result.classes_before
* "spatial_ranks before’ := spatial_stats.ranks_before
* "spatial_distances_after" := geo result.distances_after
* "spatial_categories_after" := geo result. classes_after
* "spatial_ranks_after" := spatial_stats. ranks_after
¢

"High"], thresholds=("hellinger":@.1,"tau_b":1. 0}

“spatial_H" := spatial_stats hellinger
“spatial_tau_b" := spatial_stats tau_b

“spatial_disruption’ := spatial_stats. disruption

‘You MAY round numbers to <=12 decimals; you MUST NOT round a positive Hellinger to @.@.)

MIRROR & ASSERT (HARD KILL-SWITCH)
- After all tools succeed and BEFORE emitting <final_json>, you MUST perform these checks
1) Equality mirror: For CD/Popular ity/Spatial ,

- ISON “¥ disruption” MUST equal the tool boolean exactly.

= Every numeric/debug field MUST equal the tool field (same values up to normal float formatting)

If ANY mismatch -> RECONSTRUCT the JSON by directly copying the tool dicts (no free-typing)

If still mismatched -> emit <final_json>{"error":"no_final_json"}</final_json>
2) Ranges: @<=cd_ QcokHeet, -1<2k tau_b<=1 (numeric). If violated, re-call tool or emit error JSON
3) Echo Gates re-check for categories & popularity (lengths and per-item equality to itineraries). If violated, fix and re-call tools
SPATIAL EQUALITY CHECKLIST (REPLACE)
Assert deep equality (after allowed rounding) between your JSON spatial fields and the two tool outputs (geo_distance_segments +
stats_fromcategories). If "spatial_categories before |= spatial_categor ies_after" while tool.hellinger2@ still appears as @.0 in your:
JSON, discard and rebuild; if unresolved, emit error JSON

A) Atomic Intents Builder (MUST OVERWRITE)
~ set
cd_flag = cd_from_categories. cd_disruption
pop_flag := stats_from_categor ies(popularity) .disruption
spa_flag := stats_from_categor ies(spatial) disruption
~ Deterministic order ing
1) “Category diversity disruption" if cd_flag
2) “Popularity disruption" if pop_flag
3) "Spatial distance disruption" if spa_flag
= Overwrite TSON["Intents"] with exactly these (or C"UNKNOWN"] if none true). No trimming to match target counts

4) Target Intent Count (planning only)
= Input "Target Intent Count" is ONLY for choosing index/POL; NEVER appears in output

5) Final JSON Hygiene
~ only double-quoted strings; no trailing commas; no NaN/Inf; booleans are true/false
- Keys required (exact names)

Ferturbed Itinerary": [...1
“Intents": C...1,

"categories_raw_before": [...J,
“categories_set_before": [...]
“categories_raw_after": [...J,
“categories_set_after": [...J,
“cd_before": <float>,
“cd_after": <float>,
"cd_disruption": true|false,

“popular ity_distribution_before": { "High": <Float>, "Medium": <Float>, "Low": <float> 3,


===== page-26.png =====

Conference acronym "XX, June 03-05, 2018, Woodstock, NY Huang et al

6 (continued): System prompt of itinerary perturbation for our E operation)

“popularity_distributionafter": { "High": <Float>, "Medium": <Float>, "Low": <float> 3,
“popularity_ranks_before": { ... 7,

“popularity_ranks_after": £7,

“popularity H": <Float>,

“popularity_tau_b": <Float>,

“popular ity_disruption": true|false,

"spatial_distances_before": [...]
“ spatial_categor ies_before"
"spatial_ranks_before": {
"spatial_distances_after"
"spatial_categor ies_after"
“spatial_ranks_after": {
“spatial_H": <float>,
“spatial_tau_b": <float>,
"spatial_disruption’: true/false
2

Output discipline
= Do NOT compute metrics in text; use tools only and MIRROR

- Inmediately before </final_json>, run MIRROR & ASSERT and the Atomic Intents Builder (overwrite JSON["Intents"])

- If any assertion fails and cannot be corrected by tool re-calls, output <final_json>{"error":"no_final_json"}</final_json>


===== page-27.png =====

iTIMO: An LLM-empowered Synthesis Dataset for Travel Itinerary Modification Conference acronym "XX, June 03-05, 2018, Woodstack, NY

Box 7: Template of memory module

In round (}, the operation is (3
The POIs you have chosen for {} include (}
The positions (indexes) you has chosen are (}


===== page-28.png =====

Conference acronym "XX, June 03-05, 2018, Woodstock, NY Huang et al

B stem prompt of itinerary modification (ADD operation)

You are an itinerary editor with strong reasoning over distributions and ranking patterns

[Inputs]
You will receive

1) Need-to-Modify Itinerary (length m): a JSON array of activities, each

[POI name, POI category, longitude, latitude, popularity(*High" |"Medium" | "Low" )]

2) Candidate POIs: an array of objects with keys "cand_id" and "poi" (where "poi" is the same 5-tuple)
3) Hints: high-level guidance; may mention any subset of axes: Popularity / Categories / Spatial

4) Spatial thresholds (kilometers): threshold_lowkm, threshold_high_km.

Class rule for consecutive-leg distances (Haversine, Earth radius 6371 0088 kn)

Low if d < threshold lowkm; High if d > threshold_high_km; Medium otherwise

[End of Inputs]

[Task]
Perform exactly ONE edit: INSERT one candidate POI at index i in [0..m] to REPAIR the itinerary.

Your edit mst satisfy both

A) On every hinted axis => a distribution shift is present after INSERT vs before INSERT

- For popularity and spatial axes

Mixture shift: Hellinger distance H between normalized frequency distributions > @.1; OR

Ranking-order shift: majority=>minority order of counts changes (ties allowed; check internally)

- For category axis (category diversity, CD)

Define CD = number of unique categories / length of itinerary, except when number of unique categories =1, set CD =@
If CObefore != CO_after, then category diversity is considered to have changed (a shift is detected)

8) On every non-hinted axis => distribution remains invariant

= For popularity and spatial axes

* Mixture invariance: H <= @.1; AND

% Ranking-order invariance: order unchanged

- For category axis (category diversity, CD)

* CD_before must equal CD_after (CD_before = CD_after), i.e., category diversity does not change

[end of Task]

[cuidance]
1) When determining which candidate POI to insert and at which index, first prioritize changes in popularity and category diversity
(or lack thereof) according to the shift/invariance requirements. Only after evaluating popularity and category diversity
should you consider changes or invariance in spatial distance. In other words, always give priority to popularity and
category axes when optimizing for the required shift/invariance before taking spatial distance into account
2) To reduce process bias, systematically evaluate all combinations of candidates and insertion indices without favoring any
particular candidate or index order. Avoid always starting reasoning fron the first candidate or fron the first index
Pay careful attention to selecting the correct insertion index (insert_index) and to evaluating all candidate POIs systematically
For robust reasoning, thoroughly test all (candidate, index) pairs for compliance with shift/invariance requirements across hinted
and non-hinted axes. To avoid bias, do not process candidates or indices in a strictly sequential or default order - ensure every
candidate and index position is considered equally. Many LLMs exhibit position bias by favoring the first candidate or the first
index; apply extra rigor to prevent this in both axes of selection
Ensure implementation is robust to edge cases, such as duplicate POIs, itineraries with only one or two elements, or evenly
distributed axes. Double-check the selected insert_index to confirm that the chosen edit maximizes hinted-axis shift while
maintaining invariance elsewhere, as required
[end of Guidance]

3

rs

[steps]

1) For all candidate POIs and all possible insert indices i in [@. mJ, exhaustively simulate each insertion and recompute the itinerary
state

a) Analyze: parse itinerary, candidates, and Hints; mark hinted vs non-hinted axes

b) Establish BEFORE state

= popularity counts over {"High" "Medium", "Low"};

- category counts using case-insensitive labels for counting (preserve original strings later};

= spatial class sequence over {"Low", "Medium", "High"} via thresholds; record ranking orders

- category diversity (CD) = number of unique categories / itinerary length, except when number of unique categories = 1, set CD = 0

©) Compute the AFTER state after insertion and update CD as well

2) Search: retain all options that meet A & B.

3) Select (deterministic)

= Prefer options that maximize hinted-axis shift (larger Hellinger distance and/or clear ranking change or CD change) while keeping
non-hinted deviation minimal (H close to @, order unchanged, no CD change if not hinted)

When selecting among options, assess and prioritize changes in popularity and category axes (including CD) before considering changes
in spatial distance

- Evaluate all possible (candidate, index) pairs impartially to avoid any sequence or position bias

4) Output: return exactly ONE JSON object in the specified format; do NOT include analysis, calculations, metric names, or thresholds
[end of Steps]

Coutputl

Return ONLY one JSON object with no code fences, no extra text
t

“insert_index": <int in C@..m]>,

“selected_cand_id": <string|number>,


===== page-29.png =====

iTIMO: An LLM-empowered Synthesis Dataset for Travel Itinerary Modification Conference acronym "XX, June 03-05, 2018, Woodstack, NY

B

8 (continued): System prompt of itinerary modification (ADD operation)

“selected_poi': [name, category, lon, lat, popularity],
"reason": "<Hint-grounded explanation showing shift on hinted axes and invariance on non-hinted axes>",
"confidence": <float @..1>

2
Tend of output]

[constraints & Self-check]
= Insert exactly one candidate POI; final length must be m+
= Selection must be fully deterministic given the same input; randomization is not permitted
- ver ify:
= The selected_cand_id must come from the provided candidates
= The selected_poi must be an exact, verbatim copy of the candidate's 5-tuple
- Thoroughly validate hint compliance after the change: for each hinted axis, a required shift (mixture or ranking-order for
popularity/spatial,
or category diversity change for category) mist be present; for each non-hinted axis, check both mixture invariance (Hellinger distance
<= 0.1)
and ranking-order invariance, and for category, category diversity renains unchanged
- Derive spatial classes strictly from inter-POI distances using the provided thresholds (Low/Medium/High)
- when counting categories for diversity or distribution, treat labels case-insensitively for counting but preserve their original
spelling in final output
= Do not include formulas, thresholds, or intermediate calculation details in the output JSON
- If no solution fully satisfies every constraint, select the option that achieves the strongest possible shift on hinted axes and
minimizes deviations on
non-hinted axes; clearly indicate this limitation in the "reason" field
= Assign "confidence" as follows: 1.@ for a unique, clear solution; @.7-@.9 for strong but somewhat ambiguous solutions; use lower values
for partial/no
satisfaction due to unavoidable constraints
[end of Constraints & Self-check]

(Examples

(Optional, for guidance only; do NOT copy into the final answer.)

Paste one or more raw JSON example objects here (not an array). If none, leave this section empty
[end of Examples]


===== page-30.png =====

Conference acronym "XX, June 03-05, 2018, Woodstock, NY Huang et al

B

stem prompt of itinerary modification (DELE

operation)

You are an itinerary editor with strong reasoning over distributions and ranking patterns
[Inputs]

You will receive

1) Need-to-Modify Itinerary (length mn): a JSON array of activities, each

[POI name, POI category, longitude, latitude, popularity(*High" |"Medium" | "Low" )]

2) Hints: high-level guidance; may mention any subset of axes: Popularity / Categories / Spatial
3) Spatial thresholds (kilometers): threshold_lowkm, threshold_high_km.

Class rule for consecutive-leg distances (Haversine, Earth radius 6371 0088 kn)

Low if d < threshold low km; High if d > threshold_high_km; Medium otherwise

[End of Inputs]

[Task]

Perform exactly ONE edit: DELETE one itinerary POI at index i in [@..m-1] to REPAIR the itinerary

Your edit mst satisfy both

A) On every hinted axis => a distribution shift is present after DELETE vs before DELETE

= For popularity and spatial axes

Mixture shift: Hellinger distance H between normalized frequency distributions > @.1; OR
Ranking-order shift: majority=>minority order of counts changes (ties allowed; check internally)

For category axis (category diversity, CD)

Define CD = number of unique categories / length of itinerary, except when number of unique categories =1, set CD = @
If CObefore |= CO_after, then category diversity is considered to have changed (a shift is detected)
8) On every non-hinted axis => distribution remains invariant

= For popularity and spatial axes

* Mixture invariance: H <= @.1; AND

% Ranking-order invariance: order unchanged

- For category axis (category diversity, CD)

* CD_before must equal CD_after (CD_before = CD_after), i.e., category diversity does not change

[end of Task]

[cuidance]

1) When determining which POI to delete (removed_index), first prioritize changes in popularity and category diversity (or lack thereof)
according to the shift/invariance requirements. Only after evaluating popularity and category diversity should you consider changes
or invariance in spatial distance. In other words, always give priority to popularity and category axes when optimizing for the
required shift/invariance before taking spatial distance into account

2) To reduce process bias, systematically evaluate all possible removal indices without favoring any particular index order. Avoid always

starting reasoning from the first index. Ensure every index position is considered equally. Many LLMs exhibit position bias by favoring

the first index; apply extra rigor to prevent this in your selection

Pay careful attention to selecting the correct removed_index and to evaluating all options systematically. For robust reasoning,

thoroughly test all index positions for compliance with shift/invariance requirements across hinted and non-hinted axes. To avoid bias,

do not process indices in a strictly sequential or default order - ensure every index position is considered equally.

Ensure implementation is robust to edge cases, such as duplicate POIs, itineraries with only one or two elements, or evenly distributed

axes. Double-check the selected removed_index to confirm that the chosen edit maximizes hinted-axis shift while maintaining invariance

elsewhere, as required

[end of Guidance]

[steps]

1) For all possible removal indices i in [@..m-1], exhaustively simulate each POI removal and recompute the itinerary state

a) Analyze: parse itinerary and Hints; mark hinted vs non-hinted axes

b) Establish BEFORE state

= popularity counts over {"High" "Medium", "Low"};

- category counts using case-insensitive labels for counting (preserve original strings later};

= spatial class sequence over {"Low","Medium","High"} via thresholds; record ranking orders

- category diversity (CD) = number of unique categories / itinerary length, except when number of unique categories = 1, set CD = 0
©) Compute the AFTER state after removal and update CD as well

2) Search: retain all options that meet A & B.

3) Select (deterministic)

= Prefer options that maximize hinted-axis shift (larger Hellinger distance and/or clear ranking change or CD change) while keeping
non-hinted deviation minimal (H close to @, order unchanged, no CD change if not hinted)

When selecting among options, assess and prioritize changes in popularity and category axes (including CD) before considering changes
in spatial distance

- Evaluate all possible index positions impartially to avoid any sequence or position bias

4) Output: return exactly ONE JSON object in the specified format; do NOT include analysis, calculations, metric names, or thresholds
[end of Steps]

Coutputl
Return ONLY one JSON object with no code fences, no extra text

t
“removed_index": <int in [@..m-1]>,

"reason": "<Hint-grounded explanation showing shift on hinted axes and invariance on non-hinted axes>",
"confidence": <float @..1>

2
[end of Output]


===== page-31.png =====

iTIMO: An LLM-empowered Synthesis Dataset for Travel Itinerary Modification Conference acronym "XX, June 03-05, 2018, Woodstack, NY

Box 9 (continued)

tem prompt of itinerary modification (DELETE operation)

[constraints & Self-check]
= Delete exactly one itinerary POI; length must become m-1
= Selection must be fully deterministic given the same input; randomization is not permitted
~ ver ify:
= The deleted POI index must be from the provided itinerary
- Thoroughly validate hint compliance after the change: for each hinted axis, a required shift (mixture or ranking-order for
popularity/spatial,
or category diversity change for category) mist be present; for each non-hinted axis, check both mixture invariance (Hellinger distance
<= 0.1)
and ranking-order invariance, and for category, category diversity renains unchanged
- Derive spatial classes strictly from inter-POI distances using the provided thresholds (Low/Medium/High)
- when counting categories for diversity or distribution, treat labels case-insensitively for counting but preserve their original
spelling in final output
= Do not include formulas, thresholds, or intermediate calculation details in the output JSON
- If no solution fully satisfies every constraint, select the option that achieves the strongest possible shift on hinted axes and
minimizes deviations on
non-hinted axes; clearly indicate this limitation in the "reason" field
= Assign "confidence" as Follows: 1.@ for a unique, clear solution; @.7-@.9 for strong but somewhat ambiguous solutions; use lower values
for partial/no
satisfaction due to unavoidable constraints
[end of Constraints & Self-check]

(Examples

(Optional, for guidance only; do NOT copy into the final answer.)

Paste one or more raw JSON example objects here (not an array). If none, leave this section empty
[end of Examples]


===== page-32.png =====

Conference acronym "XX, June 03-05, 2018, Woodstock, NY Huang et al

stem prompt of itinerary modification (REPLACE operation)

You are an itinerary editor with strong reasoning over distributions and ranking patterns
[Inputs]

You will receive

1) Need-to-Modify Itinerary (length mn): a JSON array of activities, each

[POI name, POI category, longitude, latitude, popularity(*High" |"Medium" | "Low" )]

2) Candidate POIs: an array of objects with keys "candid" and "poi" (where "poi" is the same 5-tuple)
3) Hints: high-level guidance; may mention any subset of axes: Popularity / Categories / Spatial

4) Spatial thresholds (kilometers): threshold_lowkm, threshold_high_km.

Class rule for consecutive-leg distances (Haversine, Earth radius 6371 0088 kn)

Low if d < threshold lowkm; High if d > threshold_high_km; Medium otherwise

[End of Inputs]

[Task]
Perform exactly ONE edit: REPLACE one itinerary POI at index i in [0..n-1] with one candidate POI to REPAIR the itinerary
Your edit mst satisfy both

A) On every hinted axis => a distribution shift is present after REPLACE vs before REPLACE

For popularity and spatial axes

Mixture shift: Hellinger distance H between normalized frequency distributions > @.1; OR

Ranking-order shift: majority=>minority order of counts changes (ties allowed; check internally)

For category axis (category diversity, CD)

Define CD = number of unique categories / length of itinerary, except when number of unique categories = 1, set CD = @
If CObefore |= CD_after, then category diversity is considered to have changed (a shift is detected)

8) On every non-hinted axis => distribution remains invariant

= For popularity and spatial axes

* Mixture invariance: H <= @.1; AND

% Ranking-order invariance: order unchanged

- For category axis (category diversity, CD)

¥ CD_before must equal CD_after (CO_before = CD_after), i.e., category diversity does not change

[end of Task]

[cuidance]
1) When determining which candidate POI to use for replacement and at which index, first prioritize changes in popularity and category
diversity
(or lack thereof) according to the shift/invariance requirements. Only after evaluating popularity and category diversity should you
consider

changes or invariance in spatial distance. In other words, always give priority to popularity and category axes when optimizing for
the required
shift/invariance before taking spatial distance into account
2) To reduce process bias, systematically evaluate all combinations of candidates and replacement indices without favoring any particular
candidate
or index order. avoid always starting reasoning from the first candidate or from the first index
3) Pay careful attention to selecting the correct replacement index (replace_index) and to evaluating all candidate Pols systematically
For robust
reasoning, thoroughly test all (candidate, index) pairs for compliance with shift/invariance requirements across hinted and non-hinted
axes. To avoid
bias, do not process candidates or indices in a strictly sequential or default order - ensure every candidate and index position is
considered equally
Many LLMs exhibit position bias by favoring the first candidate or the first index; apply extra rigor to prevent this in both axes of
selection
4) Ensure implementation is robust to edge cases, such as duplicate POIs, itineraries with only one or two elements, or evenly
distributed axes
Double-check the selected replace_index to confirm that the chosen edit maximizes hinted-axis shift while maintaining invariance
elsewhere, as required
[end of Guidance]

[steps]
1) For all candidate POIs and all possible replacement indices i in [@..m-1], exhaustively simulate each replacement and recompute the
itinerary state
a) Analyze: parse itinerary, candidates, and Hints; mark hinted vs non-hinted axes
b) Establish BEFORE state
= popularity counts over {"High" "Medium", "Low"};
- category counts using case-insensitive labels for counting (preserve original strings later};
= spatial class sequence over {"Low", "Medium", "High"} via thresholds; record ranking orders
- category diversity (CD) = number of unique categories / itinerary length, except when number of unique categories = 1, set CD = 0
©) Compute the AFTER state after replacement and update CD as well
2) Search: retain all options that meet A & B.
3) Select (deterministic)
= Prefer options that maximize hinted-axis shift (larger Hellinger distance and/or clear ranking change or CD change) while keeping
non-hinted deviation
minimal (H close to @, order unchanged, no CD change if not hinted)


===== page-33.png =====

iTIMO: An LLM-empowered Synthesis Dataset for Travel Itinerary Modification Conference acronym "XX, June 03-05, 2018, Woodstack, NY

tem prompt of itinerary modification (REPLACE operation)

- When selecting among options, assess and prioritize changes in popularity and category axes (including CD) before considering changes
in spatial distance
- Evaluate all possible (candidate, index) pairs impartially to avoid any sequence or position bias

4) Output: return exactly ONE JSON object in the specified format; do NOT include analysis, calculations, metric names, or thresholds
[end of Steps]

Coutputl
Return ONLY one JSON object with no code fences, no extra text

“replace_index": <iné in [@.m-1]>,

“selected_cand_id": <string|number>,

"selected_poi": [name, category, lon, lat, popularity],

"reason": "<Hint-grounded explanation showing shift on hinted axes and invariance on non-hinted axes>",
"confidence": <float @..1>

2
[end of Output]

[constraints & Self-check]
= Replace exactly one itinerary POL; length mist remain m.
= Selection must be fully deterministic given the same input; randomization is not permitted
~ ver ify:
= The selected_cand_id must come from the provided candidates
= The selected_poi must be an exact, verbatim copy of the candidate's 5-tuple
- Thoroughly validate hint compliance after the change: for each hinted axis, a required shift (mixture or ranking-order for
popularity/spatial,
or category diversity change for category) mist be present; for each non-hinted axis, check both mixture invariance (Hellinger distance
<= 0.1)
and ranking-order invariance, and for category, category diversity remains unchanged
- Derive spatial classes strictly from inter-POI distances using the provided thresholds (Low/Medium/High)
- when counting categories for diversity or distribution, treat labels case-insensitively for counting but preserve their original
spelling in final output
= Do not include formulas, thresholds, or intermediate calculation details in the output JSON
- If no solution fully satisfies every constraint, select the option that achieves the strongest possible shift on hinted axes and
minimizes deviations on
non-hinted axes; clearly indicate this limitation in the "reason" field
= Assign "confidence" as Follows: 1.@ for a unique, clear solution; @.7-@.9 for strong but somewhat ambiguous solutions; use lower values
for partial/no
satisfaction due to unavoidable constraints
[end of Constraints & Self-check]

(Examples

(Optional, for guidance only; do NOT copy into the final answer.)

Paste one or more raw JSON example objects here (not an array). If none, leave this section empty
[end of Examples]


===== page-34.png =====

Conference acronym "XX, June 03-05, 2018, Woodstock, NY

A.6 Proof of Lower Bound of Hellinger Distance
As mentioned before, we state that Hellinger distance is sensitive
to extreme cases regarding the macro view. For instance, given an
itinerary with length n that includes exactly one low-popularity
POI, a high-popularity POIs and n— a — 1 medium-popularity POIs,
an effective perturbation is to delete the low-popularity POI, which
aligns with the intent zpop. In section 4.2, we set the threshold
of Hellinger distance for disruption identification (ie, 6) as 0.1.
Here, we aim to theoretically verify this value can identify all the
aforementioned extreme cases. In this case, we can define the pop-
ularity distribution of original itinerary and perturbed itinerary
on it, we have the following lemma to obtain the lower bound of
Hellinger distance for measuring these two distributions.

9), respectively. Based

LemMa A.1 (LOWER BOUND OF THE HELLINGER DISTANCE UNDER
THE DELETE OPERATION). Let
an-a-1il a n-a-1
pa(S, =) a=(. 0),
a a a n-1 n-1
where n> 2 and 0 < a <n—1. Then the squared Hellinger distance
satisfies

and hence H(P,Q) = —e.

2 =1-
H(P,Q)=1 Va

Proor. Recall the squared Hellinger distance

3

We compute the Bhattacharyya coefficient:

3
aa n—a—
drm 2

The last term is zero. For the first two terms,

H(P,Q) =

a
vatn—1)

non

Therefore,

2 at(n-a-1) 2
VPit = ——— = ——— =
PD a et) Vai)

and substituting back yields

#2(p,9) =1-,f@2 bai fr— 4,
7 7

To derive a lower bound, we use the identity

x [0,1]
Setting x = 4 gives
1 Loy
(P,Q) = —S—— 2 4=-,
(P,Q) 2 "in

1
1+1-2

< 2. Taking square roots completes the proof,

1 1
H(P,Q) = {z- =

since1+.f1-2

Huang et al.

Based on Lemma A.1, we can find that with the increase of
itinerary length n, the lower bound of Hellinger distance decreases.
‘To guarantee that the threshold @ enables Hellinger distance to
identify disruption, we have to satisfy @ < 1/W2n, and we have
ns 1/267. In section 4.2, we set @ to 0.1, and we have n < 50.
This means that for any itinerary whose length is no more than 50,
Hellinger distance can identify disruption in extreme cases. In our
dataset, the maximum of itinerary length is 21, which verifies the
effectiveness of setting 6 to 0.1.

It is noted that the aforementioned case is design under the
DELETE operation. We further generalize it to the ADD and RE-
PLACE operations.

LEMMA A.2 (LOWER BOUND OF THE HELLINGER DISTANCE UNDER
THE ADD OPERATION). Let
ain

1
e=(5 ntl =a)
wheren > 1 and0 <a <n. Then the squared Hellinger distance
satisfies

H?(P,Q) =

7 1
y andhence H(P,Q) >
n+l (Be a(n +1

Proor. Recall the squared Hellinger distance

3
#(P.Q) = 1-)) vem.

We compute the Bhattacharyya coefficient:

3
aa a ana T

vem = 4/7 - + : +afo- ee.
Dy Pia ,E n+l Y a nti \ n+

The last term is zero. For the first two terms,

aa naa naa a
ntl Vn(n+i) ntl Vane)
Therefore,

3 a+(n—a) n 7%
Dy Pai Ea) Vari) Val”

and substituting back yields

1
HP(P,Q) =1- 1-———.
(7.9) ntl ri
i+d
To derive a lower bound, we use the identity
1 x

Vive Vivx(i+Viea)

Setting x = 2 gives

x20.

1 1 1
HP(P,Q) = # >—

Jithae itd) 20 +8) 2rd)"
since J+} < 1+} and thus f1+4(1+1+4) < (1+})}-

2(1+ 4) =2(1 +4)’, in particular it is atmost 2(1 + 4) forn > 1.

Taking square roots completes the proof

1

1
2(n+1) @n+1)

H(P.Q) =

===== page-35.png =====

iTIMO: An LLM-empowered Synthesis Dataset for Travel Itinerary Modification

fa]

When @ = 0.1, we have n < 49. In our dataset, the maximum
of itinerary length is only 21, which verifies the effectiveness of
setting 6 to 0.1.

Lemma A.3 (LOWER BOUND OF THE HELLINGER DISTANCE UNDER
tHE REPLACE operation). Let
p=(£ 4), g-(4 244)
nn monn
where n > 2 and1 <a <n. Then the squared Hellinger distance
satisfies

NMEA DED thence HP.) > Ze.

2
F(P,Q) a om

FS

Proor. Recall the squared Hellinger distance

3

We compute the Bhattacharyya coefficient:

3

a a-i fa-a a— 1
> pa = — + . O--.
a a a a a a

The last term is zero. For the first two terms,
AE a—1_ ya(a—1) ma n—-a@_ n-a
n na n , n a on

Therefore,
Vala—1 + (n-a)

n

H(P,Q) =

3
Daa =

and substituting back yields

yala—)+(-a)_ a~yala—)

H(P,Q) =
a a
To derive a lower bound, we use the identity
2 —a(a-1) _ a

a+ Jala—1) a+ Va(a-1)
a loa 1

1
Boas,
a a+ Jalal) 7% 2a 2n
since a+ a(a— 1) < 2a. Taking square roots completes the proof

1 1
A(P,.Q) =4f/— =.
OO) Vin” Tas

fa]

This lower bound is the same as that under the DELETE op-
eration. Therefore, 9 = 0.1 enables Hellinger distance to identify
disruption in extreme cases.

Conference acronym "XX, June 03-05, 2018, Woodstack, NY
